<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kurukshetra Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* WhatsApp-specific tweaks */
        body { background-color: #d1d7db; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .wa-bg { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-opacity: 0.4; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .message-box { box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .triangle-left::before {
            content: ""; position: absolute; left: -8px; top: 0; width: 0; height: 0;
            border-top: 0px solid transparent; border-bottom: 15px solid transparent; border-right: 15px solid white;
        }
        .triangle-right::before {
            content: ""; position: absolute; right: -8px; top: 0; width: 0; height: 0;
            border-top: 0px solid transparent; border-bottom: 15px solid transparent; border-left: 15px solid #d9fdd3;
        }
    </style>
</head>
<body class="h-screen flex justify-center items-center">

    <div class="w-full h-full md:max-w-md md:h-[90vh] bg-[#efeae2] relative flex flex-col md:shadow-2xl md:rounded-xl overflow-hidden">
        
        <div class="bg-[#008069] p-3 flex items-center justify-between text-white shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#008069] font-bold text-xl">K</div>
                <div class="leading-tight">
                    <h1 class="font-semibold text-base">Kurukshetra Gov</h1>
                    <p class="text-[11px] opacity-80">Official Assistant</p>
                </div>
            </div>
            <div class="flex gap-4 relative">
                <i data-lucide="search" class="w-5 h-5"></i>
                <button onclick="toggleMenu()"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                
                <div id="menu-dropdown" class="hidden absolute right-0 top-10 bg-white text-gray-800 shadow-xl rounded py-2 w-40 z-30">
                    <button onclick="clearChat()" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Clear chat</button>
                </div>
            </div>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 wa-bg relative">
            
            <div class="flex justify-center mb-6">
                <div class="bg-[#ffeecd] text-[10px] px-3 py-1.5 rounded-lg shadow-sm text-center text-gray-600 max-w-[80%]">
                    <i data-lucide="lock" class="w-3 h-3 inline mr-1 mb-0.5"></i>
                    Messages are grounded in <b>kurukshetra.gov.in</b>.
                </div>
            </div>

            <div id="messages-list" class="space-y-2 pb-12"></div>
            
            <div id="loading-indicator" class="hidden flex justify-start animate-pulse">
                <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm text-sm text-gray-500">
                    Typing...
                </div>
            </div>
        </div>

        <div id="chips-container" class="absolute bottom-[70px] left-0 w-full px-2 py-2 flex gap-2 overflow-x-auto hide-scrollbar z-10 transition-all">
            </div>

        <div class="bg-[#f0f2f5] p-2 flex items-center gap-2 z-20">
            <i data-lucide="smile" class="text-gray-500 w-6 h-6"></i>
            <i data-lucide="paperclip" class="text-gray-500 w-6 h-6"></i>
            <input type="text" id="user-input" placeholder="Type a message" 
                class="flex-1 py-2 px-4 rounded-lg border-none focus:outline-none text-sm h-10"
                onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" class="bg-[#008069] p-2 rounded-full text-white hover:bg-[#006a57] transition">
                <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
            </button>
        </div>
    </div>

    <script>
        // CONFIGURATION: Replace with your n8n Webhook URL
        const N8N_WEBHOOK_URL = "https://n8n-workflow-test.duckdns.org/webhook/chat"; 

        const SAMPLE_QUESTIONS = [
            "Who is the DC?", "Emergency contacts", "Tourist places", "Latest Tenders", "SDM Office contact"
        ];

        let messages = JSON.parse(localStorage.getItem('kwr_chat_history')) || [];

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            renderMessages();
            renderChips();
            scrollToBottom();
        });

        // --- Rendering ---
        function renderMessages() {
            const container = document.getElementById('messages-list');
            container.innerHTML = messages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[85%] p-2 px-3 rounded-lg shadow-sm text-[14px] leading-relaxed relative message-box 
                        ${msg.role === 'user' ? 'bg-[#d9fdd3] rounded-tr-none triangle-right' : 'bg-white rounded-tl-none triangle-left'}">
                        <div class="text-gray-800 break-words">${formatText(msg.content)}</div>
                        <div class="text-[10px] text-gray-500 text-right mt-1 flex justify-end gap-1">
                            ${msg.time} ${msg.role === 'user' ? '<span class="text-[#53bdeb]">✓✓</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderChips() {
            if (messages.length > 0) { // Only show chips if chat is empty or upon user request logic
               // Optional: Decide when to show/hide chips. For now, let's keep them always or hide after chat starts.
               // Let's hide them if there are many messages to declutter, or keep them for quick access.
            }
            const container = document.getElementById('chips-container');
            container.innerHTML = SAMPLE_QUESTIONS.map(q => `
                <button onclick="handleChipClick('${q}')" class="whitespace-nowrap bg-white text-[#008069] border border-[#e2e2e2] px-3 py-1.5 rounded-full text-xs shadow-sm font-medium hover:bg-gray-50 transition">
                    ${q}
                </button>
            `).join('');
        }

        function formatText(text) {
                // Safety check
                if (!text) return '';
            // Convert URLs to links and newlines to breaks
            let formatted = text.replace(/\n/g, '<br>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // Bold
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return formatted.replace(urlRegex, '<a href="$1" target="_blank" class="text-[#027eb5] hover:underline">$1</a>');
        }

        // --- Logic ---
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function handleChipClick(text) {
            document.getElementById('user-input').value = text;
            sendMessage();
        }

async function sendMessage() {
    const inputEl = document.getElementById('user-input');
    const text = inputEl.value.trim();
    if (!text) return;

    // 1. Add User Message
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    messages.push({ role: 'user', content: text, time: time });
    saveChat();
    renderMessages();
    scrollToBottom();
    inputEl.value = '';

    // 2. Show Loading
    document.getElementById('loading-indicator').classList.remove('hidden');
    document.getElementById('chips-container').classList.add('hidden');
    scrollToBottom();

    try {
        // 3. Call n8n
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        });
        
        const data = await response.json();
        console.log('API Response:', data); // DEBUG LINE
        
        // 4. Add Bot Message - FIXED
        let botContent = data.response || 'No response received';
        
        const botTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        messages.push({ role: 'bot', content: botContent, time: botTime });
        saveChat();

    } catch (error) {
        console.error('Error:', error);
        const errorTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        messages.push({ role: 'bot', content: "⚠️ Unable to connect to server. Please try again.", time: errorTime });
        saveChat();
    } finally {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('chips-container').classList.remove('hidden');
        renderMessages();
        scrollToBottom();
    }
}

        // --- Utilities ---
        function saveChat() {
            localStorage.setItem('kwr_chat_history', JSON.stringify(messages));
        }

        function clearChat() {
            if(confirm("Delete this chat?")) {
                messages = [];
                localStorage.removeItem('kwr_chat_history');
                renderMessages();
                toggleMenu();
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('menu-dropdown');
            menu.classList.toggle('hidden');
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
