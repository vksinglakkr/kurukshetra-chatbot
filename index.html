<!doctype html>

<!-- 
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  KURUKSHETRA MITRA ULTIMATE                   â•‘
â•‘              Your Complete Spiritual & Heritage Guide          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  File Statistics:                                             â•‘
â•‘  â€¢ Lines of Code: 2,908                                      â•‘
â•‘  â€¢ File Size: 115KB                                      â•‘
â•‘  â€¢ Total Topics: 32 (8 per user type)                        â•‘
â•‘  â€¢ Total Questions: 300+                                      â•‘
â•‘  â€¢ User Types: 4 (Pilgrim, Tourist, Student, Citizen)       â•‘
â•‘                                                               â•‘
â•‘  Features:                                                    â•‘
â•‘  âœ“ Simple Chat & Power Mode                                  â•‘
â•‘  âœ“ Voice Input Recognition                                   â•‘
â•‘  âœ“ Text-to-Speech Output                                     â•‘
â•‘  âœ“ Multi-language Support (English/Hindi/Punjabi)           â•‘
â•‘  âœ“ Autocomplete Suggestions                                  â•‘
â•‘  âœ“ Progressive UI Collapse                                   â•‘
â•‘  âœ“ Modal Answer Display                                      â•‘
â•‘  âœ“ WhatsApp Sharing                                          â•‘
â•‘  âœ“ Related Questions                                         â•‘
â•‘  âœ“ Chat History Management                                   â•‘
â•‘  âœ“ Responsive Design                                         â•‘
â•‘  âœ“ Advanced Answer Depth Control                             â•‘
â•‘                                                               â•‘
â•‘  Created: January 2026                                        â•‘
â•‘  Technology: HTML5, TailwindCSS, Vanilla JavaScript         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kurukshetra Mitra (à¤•à¥à¤°à¥à¤•à¥à¤·à¥‡à¤¤à¥à¤°à¤®à¤¿à¤¤à¥à¤°) â€“ Your Complete Spiritual & Heritage Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
</head>
<body class="min-h-screen flex flex-col items-center p-2 md:p-4">

<!-- Om Symbol Background Decorations -->
<div class="om-symbol om-top-left">ğŸ•‰ï¸</div>
<div class="om-symbol om-bottom-right">ğŸ•‰ï¸</div>


<div class="container-main w-full max-w-3xl md:max-w-4xl glass-card rounded-xl md:rounded-3xl shadow-2xl overflow-hidden flex flex-col" style="height: calc(100vh - 1rem); max-height: calc(100vh - 1rem);">
  <div class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 shadow-lg" style="border-bottom: 3px solid #fb923c;">
  <!-- Top Row: Logo + Title + Actions -->
  <div class="flex items-center justify-between p-3 md:p-4">
    <div class="flex items-center gap-2 md:gap-3">
      <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-orange-400 to-amber-500 rounded-full flex items-center justify-center text-xl md:text-2xl shadow-md">
        ğŸ•‰
      </div>
      <div>
        <h2 class="font-bold text-base md:text-lg text-gray-800">Kurukshetra Mitra â€¢ <span class="font-semibold">à¤•à¥à¤°à¥à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤®à¤¿à¤¤à¥à¤°</span></h2>
        <p class="text-xs text-gray-600 font-semibold">Your Complete Guide to Kurukshetra</p>
      </div>
    </div>
    
    <!-- Spacer for mobile -->
    <div class="w-2"></div>
  </div>
  
  <!-- Bottom Row: Mode Toggle -->
  <div class="flex items-center justify-center px-3 md:px-4 pb-3 pt-2 border-t border-orange-200">
    <div class="mode-toggle-container">
      <span class="mode-label" id="simpleModeLabel">ğŸ’¬ Simple Chat</span>
      <div class="mode-toggle power" id="modeToggle" onclick="toggleMode()">
        <div class="mode-toggle-slider"></div>
      </div>
      <span class="mode-label active" id="powerModeLabel">âš¡ Full Features</span>
    </div>
  </div>
</div>

<!-- Laws Info Strip (Below Header) -->
<div class="bg-gradient-to-r from-orange-50 to-amber-50 border-b-2 border-orange-200 px-3 py-2">
  <p class="text-xs text-center font-semibold text-orange-800">
    <span class="hidden sm:inline">Sacred Heritage â€¢ Pilgrimage Sites â€¢ Tourism â€¢ Culture â€¢ Administrative Services</span>
    <span class="sm:hidden">Pilgrimage â€¢ Tourism â€¢ Services</span>
  </p>
</div>
<!-- Simple Mode Profile Selector -->
<div id="simpleProfileSelect" class="mb-4" style="display: none;">
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-3">
    <div class="flex items-center gap-3">
      <span class="text-2xl" id="simpleProfileIcon">ğŸ§‘â€ğŸ’¼</span>
      <select id="simpleUserSelect" 
              class="flex-1 px-4 py-2 border-2 border-blue-300 rounded-lg bg-white focus:border-blue-500 outline-none"
              onchange="selectSimpleUser(this.value)">
        <option value="citizen">ğŸ‘¤ Resident / Citizen</option>
        <option value="student">ğŸ“ Student / Researcher</option>
        <option value="police">ğŸ™ Pilgrim / Devotee</option>
        <option value="legal">ğŸ•‰ Tourist / Visitor</option>
      </select>
    </div>
  </div>
</div>
 <div class="p-2 md:p-3 flex-1 overflow-y-auto">
      <!-- ALWAYS VISIBLE: What brings you here ? -->
      <div class="mb-4" id="profileAccordion" class="power-mode-only">
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-2xl p-4 hidden" id="profileSelector">
  <label class="block text-base font-bold text-gray-800 mb-3 flex items-center gap-2">
        <span class="bg-blue-100 text-blue-700 rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold">ğŸ‘¤</span>
            What is your purpose? / à¤†à¤ª à¤¯à¤¹à¤¾à¤ à¤•à¤¿à¤¸ à¤‰à¤¦à¥à¤¦à¥‡à¤¶à¥à¤¯ à¤¸à¥‡ à¤†à¤ à¤¹à¥ˆà¤‚?
            <span class="text-xs font-normal text-gray-600"></span>
          </label>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <div class="user-card-small" id="userPoliceMain" onclick="selectMainUser('police')">
              <div class="user-icon-small">ğŸ™</div>
              <div class="user-title-small">Pilgrim / Devotee</div>
              <div class="user-desc-small">Gita sites, Temples, 48 Kos</div>
            </div>
            
            <div class="user-card-small" id="userLegalMain" onclick="selectMainUser('legal')">
              <div class="user-icon-small">ğŸ•‰</div>
              <div class="user-title-small">Tourist / Visitor</div>
              <div class="user-desc-small">Sightseeing, Culture, Stay</div>
            </div>
            
            <div class="user-card-small" id="userStudentMain" onclick="selectMainUser('student')">
              <div class="user-icon-small">ğŸ‘¨â€ğŸ“</div>
              <div class="user-title-small">Student/Researcher</div>
              <div class="user-desc-small">History, Gita, Mahabharata</div>
            </div>
            
            <div class="user-card-small" id="userCitizenMain" onclick="selectMainUser('citizen')">
              <div class="user-icon-small">ğŸ§‘â€ğŸ’¼</div>
              <div class="user-title-small">Resident / Citizen</div>
              <div class="user-desc-small">Services, Facilities, Support</div>
            </div>
          </div>
          
        </div>
<div id="profileSummary"
     class="mt-2 p-3 bg-blue-50 border-2 border-blue-300 rounded-xl flex items-center justify-between cursor-pointer"
     onclick="expandProfileSelector()">
  <div class="text-sm font-bold text-blue-900">
    ğŸ‘¤ Profile selected:
    <span id="profileSummaryText">Resident / Citizen</span>
  </div>
  <div class="text-xs text-blue-700 font-semibold">
    Change
  </div>
</div>
      </div>
      
     <div class="query-type-selector hidden">
        <h3 class="text-xl font-bold text-gray-900 mb-4 text-center flex items-center justify-center gap-2">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          How would you like to proceed?
        </h3>
        
        <div class="radio-option selected" id="customCard" onclick="selectQueryType('custom')">
          <input type="radio" name="queryType" value="custom" checked onclick="event.stopPropagation(); selectQueryType('custom')">
          <span class="radio-icon">âœï¸</span>
          <div class="radio-label">
            <div class="radio-label-title">Ask Your Own Question</div>
            <div class="radio-label-desc">Type your question about Kurukshetra</div>
          </div>
        </div>
        
        <div class="radio-option" id="readyCard" onclick="selectQueryType('ready')">
          <input type="radio" name="queryType" value="ready" onclick="event.stopPropagation(); selectQueryType('ready')">
          <span class="radio-icon">ğŸ“‹</span>
          <div class="radio-label">
            <div class="radio-label-title">Select Guided Options</div>
            <div class="radio-label-desc">Choose by purpose and category</div>
          </div>
        </div>
      </div>
      <!-- Compact Query Type Summary (hidden initially) -->
<!-- Compact Query Type Summary (hidden initially) -->
<div id="queryTypeSummary"
     class="mt-2 p-3 bg-amber-50 border-2 border-amber-300 rounded-xl
            flex items-center justify-between cursor-pointer"
     onclick="expandQueryType()"
     style="display: none;">
  <div class="text-sm font-bold text-amber-900">
    ğŸ“Œ Mode:
    <span id="queryTypeSummaryText">Ask Your Own Question</span>
  </div>
  <div class="text-xs font-semibold text-amber-700">
    Change
  </div>
</div>


      <div id="questionSection">
        
        <!-- CUSTOM QUESTION DIV -->


        <!-- READY QUESTIONS DIV -->
        <div id="readyQuestionDiv" style="display: none;" class="mb-8 fade-in">
          
          <!-- Step 1: WHAT TOPIC? (Profile already selected at top) -->
          <div class="mb-1 mt-3" id="topicSection" style="display: none;">
            <label class="block text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">1</span>
              ğŸ“š What do you want to do in Kurukshetra?
            </label>
           
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2" id="topicContainer">
              <!-- Topics will load here dynamically -->
            </div>
          </div>
          
          <!-- Step 2: SELECT YOUR QUESTION -->
          <div class="mb-2" id="questionSelectSection" style="display: none;">
            <label class="block text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">2</span>
              â“ Select Your Question
            </label>
            
<select id="questionSelect"
        class="compact-dropdown block w-full px-5 py-4 text-base border-3 border-orange-400 focus:ring-4 focus:ring-orange-200 rounded-2xl bg-gradient-to-br from-white to-orange-50 shadow-lg transition-all font-medium mb-4">
  <option value="" selected disabled>Tap to select a question...</option>
</select>
          </div>
          
          <!-- Language + Submit button for ready-made questions -->
          <div class="flex items-center justify-between gap-3 mt-4">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <span>Language:</span>
              <select id="languageSelectReady"
                      class="px-2 py-1 border border-gray-300 rounded-md text-sm bg-white focus:border-orange-400 focus:ring-1 focus:ring-orange-200">
                <option value="english">English</option>
                <option value="hindi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                <option value="punjabi">à¨ªà©°à¨œà¨¾à¨¬à©€</option>
              </select>
            </div>
            
            <button id="submitBtn"
                    class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600
                           text-white font-bold py-3 rounded-xl shadow-lg
                           hover:from-orange-600 hover:to-orange-700 transition"
                    style="display: none;">
              âš¡ Get Answer
            </button>
          </div>
          
        </div> 

      </div>
    </div>
<div id="customQuestionDiv" class="mb-8 fade-in">
  <!-- Input Row: Input + Mic + Send Button -->
  <div class="flex gap-0.5 md:gap-2 mb-2">
<input
  type="text"
  id="userInput"
  class="flex-1 px-3 md:px-4 py-2 md:py-3 border-2 border-gray-300 rounded-full outline-none focus:border-orange-500 transition-all duration-300 text-sm md:text-base"
  placeholder="ğŸ’¬ Type your question..."
  oninput="showAutocompleteSuggestions()"
  onfocus="showAutocompleteSuggestions()"
  onkeypress="if(event.key==='Enter') getAnswer()"
/>
<button
  id="voiceBtn"
  class="px-2.5 md:px-4 py-3 bg-white border-2 border-gray-300 text-orange-500 hover:text-orange-700 hover:border-orange-500 rounded-full transition-all shrink-0"
  title="Click to speak"
>
  <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
  </svg>
</button>
<button
  onclick="getAnswer()"
  class="px-3 md:px-6 py-3 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-full font-medium hover:from-orange-600 hover:to-amber-700 transition flex items-center justify-center gap-1 md:gap-2 text-sm md:text-base shrink-0"
  title="Send"
>
  <svg class="w-5 h-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
  </svg>
  <span class="hidden sm:inline-flex items-center gap-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
    </svg>
    Send
  </span>
</button>
  </div>
  
  <!-- Helper Text -->
  <div class="flex items-center justify-between text-xs text-gray-500 mb-1 pl-2">
    <span>Press Enter to send</span>
    <span id="inputStatus"></span>
  </div>
  
  <!-- Autocomplete Suggestions Box -->
  <div id="autocompleteSuggestions" class="hidden mt-2 bg-white border-2 border-orange-300 rounded-xl shadow-lg max-h-60 overflow-y-auto">
    <!-- Suggestions will be added here dynamically -->
  </div>
    <!-- Language selector for custom questions -->
  <div class="flex items-center gap-2 text-sm text-gray-600 mt-1 pl-2">
    <span>Language:</span>
    <select id="languageSelect"
            class="px-2 py-1 border border-gray-300 rounded-md text-sm bg-white focus:border-orange-400 focus:ring-1 focus:ring-orange-200">
      <option value="english">English</option>
      <option value="hindi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
      <option value="punjabi">à¨ªà©°à¨œà¨¾à¨¬à©€</option>
    </select>
  </div>
</div>
<div class="border-t border-gray-300 px-2 py-1.5 bg-gray-50">
  <p class="text-center text-xs text-gray-600">
    <span class="text-orange-600 font-semibold">ChatGpt</span> â€¢ <span class="text-orange-600 font-semibold">Groq</span>
    <span class="text-gray-400 mx-1">|</span>
    <strong>NIC KKR</strong>
    <span class="text-gray-400 mx-1">|</span>
    <span id="lastModified" class="text-gray-700 font-medium">4th Jan, 19:34</span>
  </p>
</div>

  </div>
<!-- CHAT INTERFACE FOR SIMPLE MODE -->
<div id="chatInterface" class="hidden fixed inset-0" style="z-index: 1000; background: radial-gradient(ellipse at top, #1e3a8a, #0f172a);">
  <!-- Chat Container -->
<div class="h-full max-w-5xl mx-auto flex flex-col p-2 md:p-4">
  
<!-- Chat Header -->
<div class="bg-white rounded-xl md:rounded-3xl shadow-2xl overflow-hidden flex flex-col" style="height: 100%; max-height: 100%;">
<div class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 shadow-lg" style="border-bottom: 3px solid #fb923c;">
  <!-- Top Row: Logo + Actions -->
<div class="flex items-center justify-between p-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-amber-500 rounded-full flex items-center justify-center text-2xl shadow-md">
        ğŸ•‰
      </div>
      <div>
        <h2 class="font-bold text-lg text-gray-800">Kurukshetra Mitra</h2>
        <p class="text-xs text-gray-600 font-semibold" id="chatHeaderStatus">AI Heritage Guide â€¢ Online</p>
      </div>
    </div>
    
    <!-- Header Actions -->
    <div class="flex items-center gap-2">
      <button onclick="clearChatHistory()" class="hover:bg-orange-100 p-2 rounded-full transition text-orange-600" title="Clear chat history">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- Bottom Row: Mode Toggle -->
  <div class="flex items-center justify-center px-4 pb-3 pt-2 border-t border-orange-200">
    <div class="mode-toggle-container">
      <span class="mode-label active" id="simpleModeLabel">ğŸ’¬ Simple Chat</span>
      <div class="mode-toggle" id="modeToggle" onclick="toggleMode()">
        <div class="mode-toggle-slider"></div>
      </div>
      <span class="mode-label" id="powerModeLabel">âš¡ Full Features</span>
    </div>
  </div>
</div>

    <!-- Chat Messages Area -->
<div id="chatMessages" class="flex-1 overflow-y-auto p-2 md:p-4 space-y-3 md:space-y-4" style="background: #fefefe;">
      <!-- Welcome Message -->
<!-- Welcome Message -->
<div class="flex gap-3 items-start">
<div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-600 rounded-full flex items-center justify-center text-white flex-shrink-0 chat-bot-avatar">    ğŸ•‰
  </div>
  <div class="bg-white rounded-2xl rounded-tl-none shadow-md p-4 max-w-[85%]">
    <p class="text-sm text-gray-800">
      ğŸ‘‹ Namaste! I'm <strong>Kurukshetra Mitra</strong>, your AI heritage guide.<br><br>
      Ask me anything about India's Kurukshetra - pilgrimage, temples, culture, history, services.
    </p>
    <p class="text-xs text-gray-400 mt-2">Just now</p>
  </div>
</div>

<!-- Quick Start Examples -->
<div class="px-2">
  <p class="text-xs text-gray-500 mb-2 font-semibold">âœ¨ Try asking:</p>
  
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
    <!-- Example 1 -->
<button onclick="askQuickQuestion('Where is Jyotisar and how do I reach it?')" 
class="text-left p-2 md:p-3 bg-white hover:bg-orange-50 border-2 border-orange-200 rounded-lg md:rounded-xl transition group">
  <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ“‹</span>
        <div class="flex-1">
            <p class="text-xs font-semibold text-gray-900 group-hover:text-orange-700">Where is Jyotisar and how do I reach it?</p>
          <p class="text-xs text-gray-500 mt-0.5">Location & directions</p>
        </div>
      </div>
    </button>
    
    <!-- Example 2 -->
    <button onclick="askQuickQuestion('What is the significance of Brahma Sarovar?')" 
class="text-left p-2 md:p-3 bg-white hover:bg-orange-50 border-2 border-orange-200 rounded-lg md:rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ”</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-orange-700">Significance of Brahma Sarovar?</p>
          <p class="text-xs text-gray-500 mt-0.5">Spiritual importance</p>
        </div>
      </div>
    </button>
    
    <!-- Example 3 -->
    <button onclick="askQuickQuestion('Best hotels and accommodation in Kurukshetra?')" 
class="text-left p-2 md:p-3 bg-white hover:bg-orange-50 border-2 border-orange-200 rounded-lg md:rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ’»</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-orange-700">Best hotels in Kurukshetra?</p>
          <p class="text-xs text-gray-500 mt-0.5">Accommodation options</p>
        </div>
      </div>
    </button>
    
    <!-- Example 4 -->
    <button onclick="askQuickQuestion('What are the main festivals celebrated here?')" 
class="text-left p-2 md:p-3 bg-white hover:bg-orange-50 border-2 border-orange-200 rounded-lg md:rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ•‰</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-orange-700">Festivals in Kurukshetra?</p>
          <p class="text-xs text-gray-500 mt-0.5">Cultural events</p>
        </div>
      </div>
    </button>
  </div>
</div>

    </div>

    <!-- Chat Input Area -->
  <div class="bg-white border-t border-gray-200 p-2 md:p-4 shadow-lg">
  <div class="flex gap-1 md:gap-2 mb-2">
  
<input 
  type="text" 
  id="chatInput" 
  placeholder="ğŸ’¬ Type your question..."
  class="flex-1 px-3 md:px-4 py-2 md:py-3 border-2 border-gray-300 rounded-full outline-none focus:border-orange-500 text-sm md:text-base"
          onkeypress="if(event.key==='Enter') sendChatMessage()"
        >
<button 
  onclick="sendChatMessage()" 
  class="px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-full font-medium hover:from-orange-600 hover:to-amber-700 transition flex items-center gap-1 md:gap-2 text-sm md:text-base">  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Send
        </button>
      </div>
      
    <!-- Quick Info -->
      <div class="flex items-center justify-between text-xs text-gray-500">
        <span>Press Enter to send</span>
        <span id="chatTypingStatus"></span>
      </div>
</div> <!-- End Chat Input Area -->
    
  </div> <!-- End white background wrapper -->
</div> <!-- End max-w-5xl container -->
</div> <!-- End chatInterface -->
  <!-- FIXED MODAL WITH PROPER HEIGHT MANAGEMENT -->
<div id="aiModal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 9999; background: rgba(0,0,0,0.92);">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl mx-auto flex flex-col" style="max-height: 90vh;">
  <!-- Header - Fixed -->
      <div class="flex justify-between items-center px-5 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white flex-shrink-0">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          Kurukshetra Mitra Response
        </h2>
        <button id="closeModal" class="hover:bg-white/20 p-2 rounded-full transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Scrollable Content Area -->
      <div class="p-5 overflow-y-auto bg-gray-50 flex-1" style="min-height: 0;">
        <div class="mb-5">
          <p class="font-bold text-gray-900 mb-2">Question:</p>
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl border-l-4 border-blue-500">
            <pre id="modalQuestion" class="whitespace-pre-wrap text-gray-800"></pre>
          </div>
        </div>

        <div>
          <p class="font-bold text-gray-900 mb-2">Answer:</p>
          <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 rounded-2xl border-l-4 border-orange-500">
            <pre id="modalAnswer" class="whitespace-pre-wrap text-gray-800 text-sm leading-loose"></pre>
          </div>
        </div>
      </div>

<!-- Footer -->
<div class="border-t border-gray-200 bg-white flex-shrink-0">

  <!-- Advanced Toggle -->
  <div class="text-center pt-2">
    <button onclick="toggleAdvancedFooter()"
            class="text-xs font-semibold text-gray-600 hover:text-gray-800 transition">
      âš™ Advanced <span id="advFooterArrow">â–¾</span>
    </button>
  </div>

  <!-- Advanced Panel (Hidden by default) -->
  <div id="advancedFooter" class="hidden px-4 pt-2 pb-1">

    <div class="flex items-center gap-4 flex-wrap justify-center">

      <!-- Depth -->
      <div class="flex items-center gap-2">
        <label class="text-xs font-bold text-gray-700">Depth:</label>
        <select id="depthSelector"
                class="compact-dropdown"
                onchange="changeAnswerLevel(this.value)">
          <option value="brief">Brief</option>
          <option value="standard" selected>Standard</option>
          <option value="detailed">Detailed</option>
        </select>
      </div>

      <!-- AI -->
      <div class="flex items-center gap-2">
        <label class="text-xs font-bold text-gray-700">AI:</label>
        <select id="aiSelector"
                class="compact-dropdown"
                onchange="retryWithAI(this.value)">
          <option value="chatgpt selected">ChatGPT</option>
          <option value="groq" >Groq Llama</option>
        </select>
      </div>

    </div>
  </div>

  <!-- Main Action Bar -->
  <div class="px-4 py-3 flex items-center justify-between gap-2">

    <!-- Left Actions -->
    <div class="flex items-center gap-2">
   <button id="whatsappBtn" onclick="shareOnWhatsApp()"
        class="icon-btn bg-green-600 hover:bg-green-700"
        title="Share on WhatsApp">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347M12.05 21.785h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884"/>
  </svg>
</button> 



<button id="searchBtn" onclick="openSectionSearch()"
        class="icon-btn bg-blue-600 hover:bg-blue-700"
        title="Search Related Sections">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
       aria-hidden="true">
    <circle cx="11" cy="11" r="8"></circle>
    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
</button>
<button id="listenBtn"
        onclick="toggleListen()"
        class="icon-btn bg-purple-600 hover:bg-purple-700 relative"
        title="Listen / Stop">

  <!-- ğŸ”´ ACTIVE INDICATOR -->
  <span id="listenIndicator"
        class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-600 rounded-full hidden">
  </span>

  <!-- PLAY ICON -->
  <svg id="listenIconPlay"
       viewBox="0 0 24 24"
       class="w-5 h-5 fill-white">
    <path d="M3 9v6h4l5 5V4L7 9H3z"/>
  </svg>

  <!-- STOP ICON -->
  <svg id="listenIconStop"
       viewBox="0 0 24 24"
       class="w-5 h-5 fill-white hidden">
    <path d="M6 6h12v12H6z"/>
  </svg>

</button>

    </div>

    <!-- Right -->
    <button id="closeBtn"
            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition font-semibold text-sm">
      Close
    </button>

  </div>
</div>

    </div>
  </div>

  <script>
    console.log('ğŸš€ Kurukshetra Mitra initializing...');
    let isProfileManuallyChanged = false;
    
    // Update Last Modified DateTime - AUTOMATIC FROM FILE
    function updateLastModified() {
      try {
        let lastModDate;
        
        // Get document's last modified date
        if (document.lastModified) {
          lastModDate = new Date(document.lastModified);
          console.log('ğŸ“… Document last modified (raw):', document.lastModified);
        }
        
        // Validate date
        if (!lastModDate || isNaN(lastModDate.getTime())) {
          lastModDate = new Date();
          console.log('âš ï¸ Using current date as fallback');
        }
        
        const day = lastModDate.getDate();
        const suffix = (day) => {
          if (day > 3 && day < 21) return 'th';
          switch (day % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
          }
        };
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const month = monthNames[lastModDate.getMonth()];
        const year = lastModDate.getFullYear();
        const hours = lastModDate.getHours().toString().padStart(2, '0');
        const minutes = lastModDate.getMinutes().toString().padStart(2, '0');
        
        const formattedDate = `${day}${suffix(day)} ${month} ${year}, ${hours}:${minutes} IST`;
        
        const element = document.getElementById('lastModified');
        if (element) {
          element.textContent = formattedDate;
          console.log('âœ… Last Modified displayed:', formattedDate);
        }
      } catch (error) {
        console.error('âŒ Last Modified error:', error);
        const element = document.getElementById('lastModified');
        if (element) {
          element.textContent = '17th December 2025, 23:30 IST';
        }
      }
    }
    
    // Call when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateLastModified);
    } else {
      updateLastModified();
    }

document.addEventListener('DOMContentLoaded', function () {
  // Show default hint
  const hintEl = document.getElementById('profileHint');
  if (hintEl) {
    hintEl.textContent = 'Default profile: Resident / Citizen (you can change it)';
  }
  // Set default selected user silently
  selectedUser = 'citizen';
  // Highlight default card visually
  const defaultCard = document.getElementById('userCitizenMain');
  if (defaultCard) {
    defaultCard.classList.add('selected');
  }
  console.log('âœ… Default profile initialized silently: Resident / Citizen');
  
  setTimeout(() => {
    selectQueryType('ready');
    
    // Auto-select appropriate topic based on user type
    autoSelectTopicForUserType();
  }, 100);
  
  // ===== Watch for profile card clicks =====
  const profileCards = document.querySelectorAll('[id^="user"][id$="Main"]');
  profileCards.forEach(card => {
    card.addEventListener('click', function() {
      console.log('ğŸ‘¤ Profile card clicked');
      // Wait for selectedUser to update
      setTimeout(() => {
        console.log('ğŸ‘¤ Current selectedUser:', selectedUser);
        // Only auto-select if in ready-made mode
        const readyMadeDiv = document.getElementById('readyMadeDiv');
        if (readyMadeDiv && readyMadeDiv.style.display !== 'none') {
          autoSelectTopicForUserType();
        }
      }, 100);
    });
  });
  
});
    
    const WEBHOOK_URL = 'https://n8n-workflow-test.duckdns.org/webhook/chatbot';
    
    // VERSION CHECK - This will appear in console immediately
    console.log('ğŸ”¥ Kurukshetra Mitra Version: ARRAY-FIX-v2 - Loaded at', new Date().toISOString());
    console.log('ğŸ”¥ If you see this, the new version is loaded!');
    
    let currentQuestion = '';
    let currentAI = 'chatgpt';
    let selectedUser = 'citizen'; // Default to Resident / Citizen
    let selectedTopic = '';
    let selectedQueryType = 'custom';
    let aiUsed = {
      groq: false,
      chatgpt: false
    };
    
    // User-level specific prompt instructions with ENHANCED FORMATTING
    const USER_LEVEL_PROMPTS = {
      police: {
        level: 'intermediate',
        instruction: 'You are answering for a Pilgrim / Devotee visiting sacred Kurukshetra. Provide practical spiritual guidance about temples, sarovars, rituals, parikrama routes, and devotional practices. Focus on pilgrimage procedures, darshan timings, religious ceremonies, and sacred site significance. Use respectful terminology while keeping it accessible for all devotees.',
        tone: 'Spiritual and respectful'
      },
      legal: {
        level: 'advanced',
        instruction: 'You are answering for a Tourist / Visitor exploring Kurukshetra. Provide detailed travel information with specific locations, historical context, cultural significance, and practical travel tips. Include sightseeing recommendations, best times to visit, accommodation options, dining experiences, and local attractions. Be informative and engaging.',
        tone: 'Informative and engaging'
      },
      student: {
        level: 'educational',
        instruction: 'You are answering for a Student / Researcher studying Kurukshetra. Provide comprehensive educational content about Mahabharata history, archaeology, scriptures, cultural heritage, and academic resources. Include historical facts, research perspectives, scholarly analysis, and academic references. Use structured format with key points.',
        tone: 'Educational and scholarly'
      },
      citizen: {
        level: 'basic',
        instruction: 'You are answering for a Resident / Citizen of Kurukshetra. Provide simple, easy-to-understand information about local services, government facilities, healthcare, education, transport, and civic amenities. Focus on practical everyday needs, how to access services, and step-by-step guidance. Use plain language.',
        tone: 'Simple and helpful'
      }
    };
    
    // Multi-level answer depth options (sent to n8n as metadata)
    const ANSWER_LEVELS = {
      brief: {
        label: 'ğŸ“ Brief',
        instruction: 'Provide a concise answer in 2-3 paragraphs covering only the essential points.',
        icon: 'ğŸ“'
      },
      standard: {
        label: 'ğŸ“„ Standard',
        instruction: 'Provide a comprehensive answer with all important details, examples, and relevant sections.',
        icon: 'ğŸ“„'
      },
      detailed: {
        label: 'ğŸ“š Detailed',
        instruction: 'Provide an in-depth, exhaustive answer covering all aspects, subsections, exceptions, examples, and practical implications.',
        icon: 'ğŸ“š'
      }
    };
    
    let currentAnswerLevel = 'standard'; // Default level
    
    // Main answer function - send CLEAN data to n8n
    async function getAnswer(provider, answerLevel = 'standard') {
      currentAI = provider;
      currentAnswerLevel = answerLevel;
      aiUsed[provider] = true;
      
      const loadingMessages = {
        groq: 'âš¡ Groq is processing at lightning speed...',
        chatgpt: 'ğŸ¤– ChatGPT is analyzing deeply...'
      };
      
      const providerNames = {
        groq: 'ğŸš€ Groq Llama 3.3',
        chatgpt: 'ğŸ¤– ChatGPT GPT-4o'
      };
      
      document.getElementById('modalQuestion').textContent = currentQuestion;
      document.getElementById('modalAnswer').innerHTML = loadingMessages[provider];
      document.getElementById('aiModal').classList.remove('hidden');
      
      updateModalHeader(provider);
      updateAIButtons();
      updateAnswerLevelButtons();
      
      const startTime = Date.now();
      
      try {
        // Get selected language
        const selectedLanguage = document.getElementById('languageSelect').value;
        console.log('ğŸŒ Selected language:', selectedLanguage);
        
        // Send CLEAN data - let n8n handle formatting
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: currentQuestion, // CLEAN question only
            originalQuestion: currentQuestion,
            provider: provider,
            userType: selectedUser,
            userLevel: selectedUser ? USER_LEVEL_PROMPTS[selectedUser].level : 'general',
            topic: selectedTopic,
            queryType: selectedQueryType,
            answerDepth: answerLevel,
            language: selectedLanguage,  // â† LANGUAGE PARAMETER ADDED
            timestamp: new Date().toISOString()
          })
        });
        
        if (!response.ok) throw new Error('HTTP ' + response.status);
        
        let data = await response.json();
        console.log('ğŸ“¥ RAW Received data:', JSON.stringify(data).substring(0, 200));
        console.log('ğŸ“¥ Is Array?', Array.isArray(data));
        console.log('ğŸ“¥ Type:', typeof data);
        
        // n8n returns an array, get first item
        if (Array.isArray(data) && data.length > 0) {
          console.log('ğŸ“¦ Extracting from array, length:', data.length);
          data = data[0];
          console.log('ğŸ“¦ Extracted object:', data);
        }
        
        // Handle different response formats
        let answerText = '';
        if (typeof data === 'string') {
          console.log('âœ… Format: Direct string');
          answerText = data;
        } else if (data && data.answer) {
          console.log('âœ… Format: Object with answer property');
          console.log('âœ… Answer length:', data.answer.length);
          answerText = data.answer;
        } else if (data && data.response) {
          console.log('âœ… Format: Object with response property');
          answerText = data.response;
        } else if (data && data.choices && data.choices[0] && data.choices[0].message) {
          console.log('âœ… Format: Groq API format');
          answerText = data.choices[0].message.content;
        } else {
          console.error('âŒ Could not find answer in data');
          console.error('âŒ Data keys:', data ? Object.keys(data) : 'null');
          console.error('âŒ Full data:', data);
          answerText = 'No answer generated (empty model output).';
        }
        
        // Clean up any remaining issues
        answerText = answerText.replace('[SEARCH_BUTTON]', '');
        answerText = answerText.replace(/ğŸ” SEARCH KEYWORDS:.*?\n\n/gs, '');
        
        // Convert markdown links to HTML
        function convertMarkdownLinksToHTML(text) {
          // Convert [Text](URL) to <a href="URL" target="_blank">Text</a>
          return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #3b82f6; text-decoration: underline;">$1</a>');
        }
        
        // Convert newlines to <br> and links to HTML
        answerText = answerText
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\n/g, '<br>');
        
        // Now convert markdown links (after escaping HTML)
        answerText = convertMarkdownLinksToHTML(answerText);
        
        // ============================================
        // EXTRACT AND REMOVE RELATED QUESTIONS
        // ============================================
        let relatedQuestions = [];
        
        console.log('ğŸ” Searching for related questions in answer...');
        
        // Try to find related questions section
        const relatedPattern = /â“\s*RELATED QUESTIONS[\s\S]*?(?=âš ï¸|â”â”â”|$)/i;
        const relatedMatch = answerText.match(relatedPattern);
        
        if (relatedMatch) {
          console.log('âœ… Found related questions section');
          const relatedSection = relatedMatch[0];
          
          // Split by <br> and extract questions
          const lines = relatedSection.split(/<br\s*\/?>/gi);
          
          for (let line of lines) {
            // Clean HTML entities
            let cleaned = line
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&amp;/g, '&')
              .replace(/&quot;/g, '"')
              .trim();
            
            // Skip header line and empty lines
            if (cleaned.length < 10 || cleaned.match(/RELATED QUESTIONS/i)) {
              continue;
            }
            
            // Remove bullet points, numbers, dashes
            cleaned = cleaned.replace(/^[\sâ€¢\-\d\.\)]+/, '').trim();
            
            // Must have question mark and be reasonable length
            if (cleaned.includes('?') && cleaned.length > 15 && cleaned.length < 300) {
              relatedQuestions.push(cleaned);
              console.log('  ğŸ“Œ Extracted:', cleaned.substring(0, 60) + '...');
            }
          }
          
          // Limit to 3 questions
          relatedQuestions = relatedQuestions.slice(0, 3);
          console.log('âœ… Total questions extracted:', relatedQuestions.length);
          
          // REMOVE the entire related questions section from answer
          answerText = answerText.replace(relatedPattern, '');
          console.log('âœ… Related questions section removed from answer body');
        } else {
          console.log('âš ï¸ No related questions section found');
        }
        
        const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);
        
        // Add metadata footer
        const levelEmoji = ANSWER_LEVELS[answerLevel].icon;
        const userTypeLabel = selectedUser ? ` | ğŸ‘¤ ${selectedUser.charAt(0).toUpperCase() + selectedUser.slice(1)}` : '';
        
        let finalHTML = answerText + 
          '<br><br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>' +
          `${levelEmoji} ${answerLevel.charAt(0).toUpperCase() + answerLevel.slice(1)} Answer${userTypeLabel}<br>` +
          `â±ï¸ Response: ${responseTime}s with ${providerNames[provider]}`;
        
        // ============================================
        // DISPLAY RELATED QUESTIONS DROPDOWN
        // ============================================
        if (relatedQuestions.length > 0) {
          console.log('âœ… Adding related questions dropdown');
          
          finalHTML += '<br><br>' +
            '<details open style="background: linear-gradient(to right, #fff7ed, #fef3c7); padding: 14px; border-radius: 12px; border: 2px solid #fb923c; box-shadow: 0 2px 8px rgba(251, 146, 60, 0.2);">' +
              '<summary style="cursor: pointer; font-weight: bold; color: #1f2937; display: flex; align-items: center; gap: 8px; list-style: none; user-select: none;">' +
                '<span style="font-size: 20px;">â“</span> ' +
                '<span style="font-size: 16px;">Related Questions (' + relatedQuestions.length + ')</span> ' +
                '<span style="font-size: 12px; color: #6b7280; margin-left: auto; font-weight: normal;">(Click to ask automatically)</span>' +
              '</summary>' +
              '<div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">';
          
          relatedQuestions.forEach((q, idx) => {
            // Escape quotes properly
            const escapedQuestion = q
              .replace(/\\/g, '\\\\')
              .replace(/'/g, "\\'")
              .replace(/"/g, '&quot;')
              .replace(/\n/g, ' ');
            
            finalHTML += 
              '<div style="background: white; padding: 14px; border-radius: 10px; border-left: 4px solid #fb923c; cursor: pointer; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" ' +
                   'onmouseover="this.style.background=\'#fff7ed\'; this.style.borderLeftColor=\'#f97316\'; this.style.boxShadow=\'0 4px 12px rgba(251,146,60,0.3)\'; this.style.transform=\'translateX(4px)\';" ' +
                   'onmouseout="this.style.background=\'white\'; this.style.borderLeftColor=\'#fb923c\'; this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'; this.style.transform=\'translateX(0)\';" ' +
                   'onclick="askRelatedQuestion(\'' + escapedQuestion + '\')">' +
                '<div style="display: flex; align-items: start; gap: 12px;">' +
                  '<span style="color: #f97316; font-weight: bold; font-size: 16px; min-width: 26px; margin-top: 2px;">' + (idx + 1) + '.</span>' +
                  '<span style="color: #374151; font-size: 15px; line-height: 1.6;">' + q + '</span>' +
                '</div>' +
              '</div>';
          });
          
          finalHTML += '</div></details>';
        }
        
        document.getElementById('modalAnswer').innerHTML = finalHTML;
        enableResponseActions();
        console.log('âœ… Response from', provider, 'in', responseTime, 'seconds');
        
      } catch (error) {
        console.error('âŒ Error:', error);
        document.getElementById('modalAnswer').innerHTML = 'Error: Could not connect to ' + provider.toUpperCase() + '. Please try again.';
      }
    }
    
    // Retry with different AI
    function retryWithAI(provider) {
      // Allow switching to any AI at any time
      aiUsed[provider] = true;
      getAnswer(provider, currentAnswerLevel);
    }
    
    window.retryWithAI = retryWithAI;
    
    // Change answer depth level
    function changeAnswerLevel(level) {
      currentAnswerLevel = level;
      
      // Update dropdown selection
      const depthSelector = document.getElementById('depthSelector');
      if (depthSelector) {
        depthSelector.value = level;
      }
      
      getAnswer(currentAI, level);
    }
    
    window.changeAnswerLevel = changeAnswerLevel;
    
    // Update answer level buttons (deprecated - now using dropdown)
    function updateAnswerLevelButtons() {
      const depthSelector = document.getElementById('depthSelector');
      if (depthSelector) {
        depthSelector.value = currentAnswerLevel;
      }
    }
    
    // Update AI button states (now updates dropdown)
    function updateAIButtons() {
      const aiSelector = document.getElementById('aiSelector');
      if (aiSelector) {
        aiSelector.value = currentAI;
      }
    }
    
    // Update Modal Header with AI Provider
    function updateModalHeader(provider) {
      const icons = {
        groq: 'ğŸš€',
        chatgpt: 'ğŸ¤–'
      };
      
      const names = {
        groq: 'Groq Llama 3.3',
        chatgpt: 'ChatGPT GPT-4o'
      };
      
      const header = document.querySelector('#aiModal .bg-gradient-to-r h2');
      if (header) {
        header.innerHTML = '<span class="ml-2">' + 'Kurukshetra Mitra â€“ AI Response</span>';
      }
    }
    
    // TOPICS organized by user type
    const TOPICS = {
      police: [
        { id: 'temples', icon: 'ğŸ›•', title: 'Sacred Temples', subtitle: 'Sthaneshwar, Bhadrakali, Pandava temples', law: 'Religious Sites' },
        { id: 'sarovars', icon: 'ğŸ’§', title: 'Holy Sarovars', subtitle: 'Brahma, Sannihit, Jyotisar tanks', law: 'Water Bodies' },
        { id: 'parikrama', icon: 'ğŸš¶', title: '48 Kos Parikrama', subtitle: 'Route, Duration, Facilities', law: 'Pilgrimage' },
        { id: 'gita', icon: 'ğŸ“¿', title: 'Bhagavad Gita Sites', subtitle: 'Jyotisar, Sacred Banyan Tree', law: 'Sacred Texts' },
        { id: 'rituals', icon: 'ğŸ””', title: 'Rituals & Puja', subtitle: 'Ceremonies, Offerings, Shradh', law: 'Worship' },
        { id: 'festivals', icon: 'ğŸŠ', title: 'Religious Festivals', subtitle: 'Gita Jayanti, Solar Eclipse events', law: 'Events' },
        { id: 'accommodation_p', icon: 'ğŸ¨', title: 'Pilgrim Stay', subtitle: 'Dharamshalas, Guest Houses', law: 'Lodging' },
        { id: 'guide', icon: 'ğŸ§­', title: 'Pilgrimage Guide', subtitle: 'Tips, Dos and Don\'ts', law: 'Information' }
      ],
      legal: [
        { id: 'attractions', icon: 'ğŸ—ºï¸', title: 'Tourist Attractions', subtitle: 'Panorama, Museums, Monuments', law: 'Sightseeing' },
        { id: 'travel', icon: 'ğŸš—', title: 'Travel & Transport', subtitle: 'How to reach, Local transport', law: 'Connectivity' },
        { id: 'accommodation', icon: 'ğŸ¨', title: 'Hotels & Stay', subtitle: 'Budget, Luxury, Location options', law: 'Lodging' },
        { id: 'food', icon: 'ğŸ½ï¸', title: 'Food & Dining', subtitle: 'Local cuisine, Restaurants', law: 'Dining' },
        { id: 'activities', icon: 'ğŸ¯', title: 'Activities & Tours', subtitle: 'Guided tours, Light shows', law: 'Experiences' },
        { id: 'shopping', icon: 'ğŸ›ï¸', title: 'Shopping', subtitle: 'Souvenirs, Handicrafts, Markets', law: 'Commerce' },
        { id: 'timing', icon: 'â°', title: 'Best Time to Visit', subtitle: 'Season, Weather, Events', law: 'Planning' },
        { id: 'itinerary', icon: 'ğŸ“…', title: 'Tour Itineraries', subtitle: '1-day, 2-day, Weekend plans', law: 'Planning' }
      ],
      student: [
        { id: 'mahabharata', icon: 'ğŸ“–', title: 'Mahabharata History', subtitle: 'War, Krishna, Battlefield', law: 'Epic' },
        { id: 'archaeology', icon: 'ğŸ›ï¸', title: 'Archaeological Sites', subtitle: 'Excavations, Ancient findings', law: 'Heritage' },
        { id: 'scriptures', icon: 'ğŸ“š', title: 'Scriptures & Texts', subtitle: 'Gita, Vedas, Ancient references', law: 'Literature' },
        { id: 'culture', icon: 'ğŸ­', title: 'Culture & Heritage', subtitle: 'Traditions, Folk arts, Customs', law: 'Cultural' },
        { id: 'astronomy', icon: 'ğŸŒŸ', title: 'Astronomy & Eclipse', subtitle: 'Solar eclipse significance', law: 'Science' },
        { id: 'education', icon: 'ğŸ“', title: 'Educational Institutes', subtitle: 'University, NIT, Libraries', law: 'Academics' },
        { id: 'research', icon: 'ğŸ”¬', title: 'Research Facilities', subtitle: 'Archives, Museums, Centers', law: 'Research' },
        { id: 'history', icon: 'ğŸ“œ', title: 'Historical Timeline', subtitle: 'Ancient to Modern evolution', law: 'History' }
      ],
      citizen: [
        { id: 'services', icon: 'ğŸ›ï¸', title: 'Government Services', subtitle: 'Municipal, Tax, Certificates', law: 'Administration' },
        { id: 'healthcare', icon: 'ğŸ¥', title: 'Healthcare', subtitle: 'Hospitals, Clinics, Emergency', law: 'Health' },
        { id: 'education_c', icon: 'ğŸ«', title: 'Education', subtitle: 'Schools, Colleges, Admission', law: 'Learning' },
        { id: 'transport', icon: 'ğŸšŒ', title: 'Transport', subtitle: 'Bus, Rail, Vehicle Registration', law: 'Mobility' },
        { id: 'utilities', icon: 'ğŸ’¡', title: 'Utilities', subtitle: 'Water, Power, Gas Connections', law: 'Services' },
        { id: 'safety', icon: 'ğŸš¨', title: 'Safety & Security', subtitle: 'Police, Fire, Emergency numbers', law: 'Safety' },
        { id: 'civic', icon: 'ğŸ¢', title: 'Civic Amenities', subtitle: 'Parks, Libraries, Community', law: 'Facilities' },
        { id: 'complaints', icon: 'ğŸ“', title: 'Complaints & Grievances', subtitle: 'How to register, Track status', law: 'Redressal' }
      ]
    };
    
    // Sample questions for each topic
 // FINAL COMPREHENSIVE TOPIC QUESTIONS - MERGED BEST FROM BOTH LISTS
// 660+ High-Quality Questions - No Duplicates
const TOPIC_QUESTIONS = {
  // ========================================
  // PILGRIM / DEVOTEE QUESTIONS (60+ questions)
  // ========================================
  
  temples: [
    'What are the most important temples to visit in Kurukshetra?',
    'Tell me about Sthaneshwar Mahadev Temple history and significance',
    'What is the religious importance of Bhadrakali Temple?',
    'Where are the five Pandava temples located in Kurukshetra?',
    'Which temples are included in the 48 Kos Parikrama route?',
    'What are the darshan timings of major temples?',
    'Are there any ancient Shakti Peethas in Kurukshetra?',
    'Which temples allow photography and which ones prohibit it?',
    'What is the dress code for visiting temples?',
    'Can non-Hindus visit the temples in Kurukshetra?'
  ],
  
  sarovars: [
    'What is the spiritual significance of Brahma Sarovar?',
    'Tell me about Sannihit Sarovar and its mythological importance',
    'What makes Jyotisar sacred tank so special?',
    'How many holy sarovars are there in total in Kurukshetra?',
    'What is the best time to take holy bath in the sarovars?',
    'What rituals are performed at Brahma Sarovar?',
    'Is there any specific dress code for visiting sarovars?',
    'Can I perform Shradh ceremonies at the sarovars?',
    'What is the depth and size of Brahma Sarovar?',
    'Are there changing rooms and facilities at sarovars?'
  ],
  
  parikrama: [
    'What is the complete 48 Kos Parikrama route with all stops?',
    'How many days does it take to complete the full parikrama?',
    'What are the main pilgrimage stops in 48 Kos Parikrama?',
    'When is the most auspicious time to do the parikrama?',
    'What facilities like food and water are available during parikrama?',
    'Can I do the parikrama by vehicle or must I walk?',
    'Where can I find accommodation during the parikrama?',
    'What essential items should I carry for the parikrama?',
    'Are there any age restrictions for doing parikrama?',
    'How do I register or get a guide for parikrama?'
  ],
  
  gita: [
    'Where exactly was the Bhagavad Gita narrated by Lord Krishna?',
    'What makes Jyotisar the birthplace of Bhagavad Gita?',
    'Tell me about the sacred Banyan tree and its significance',
    'What are all the Gita-related pilgrimage sites in Kurukshetra?',
    'When and how is Gita Jayanti celebrated here?',
    'Can I attend Gita discourse and study sessions?',
    'Are there any Gita museums or permanent exhibitions?',
    'What is the history and architecture of Gita Mandir?',
    'Where can I buy authentic Bhagavad Gita books?',
    'Are there any Gita recitation programs for pilgrims?'
  ],
  
  rituals: [
    'What are the most common pujas performed at Kurukshetra temples?',
    'How do I arrange to perform Shradh rituals here?',
    'What is the timing of evening aarti at Brahma Sarovar?',
    'Can I book priests in advance for special ceremonies?',
    'What offerings and materials are accepted at temples?',
    'What is the approximate cost of performing various rituals?',
    'Are there any special eclipse-related rituals?',
    'Can foreigners or NRIs perform rituals here?',
    'What is Pind Daan and where is it performed?',
    'How to perform Tarpan at the holy sarovars?'
  ],
  
  festivals: [
    'When is Gita Jayanti celebrated and what are the main events?',
    'What happens during Solar Eclipse festivals at Kurukshetra?',
    'Tell me complete details about Kurukshetra Mahotsav',
    'What is the significance of Somavati Amavasya here?',
    'Which annual festivals attract the most pilgrims?',
    'Are there grand Janmashtami celebrations in Kurukshetra?',
    'What special events happen during Kartik Purnima?',
    'Are there Mahashivratri programs at Sthaneshwar temple?',
    'When does the International Gita Festival take place?',
    'What cultural programs are organized during festivals?'
  ],
  
  accommodation_p: [
    'What dharamshalas are available for pilgrims near temples?',
    'How can I book accommodation near Brahma Sarovar?',
    'Are there any free or subsidized dharamshalas?',
    'Which areas offer the best pilgrim accommodation?',
    'Do dharamshalas provide meals and food facilities?',
    'What amenities do typical pilgrim guest houses offer?',
    'How to get accommodation during peak eclipse periods?',
    'Are there separate facilities for women pilgrims?',
    'What is the check-in and check-out timing?',
    'Can I make advance bookings for dharamshalas?'
  ],
  
  guide: [
    'What essential items should pilgrims carry while visiting?',
    'What are the important dos and don\'ts at sacred sites?',
    'Is there a mandatory dress code for temples and sarovars?',
    'How much time is needed to cover all major pilgrimage sites?',
    'Are wheelchairs and accessibility facilities available?',
    'Can I bring food offerings and prasad from home?',
    'What languages do temple priests and guides speak?',
    'What safety tips for solo female pilgrims visiting alone?',
    'Where can I find licensed pilgrimage guides?',
    'What medical facilities are available near pilgrimage sites?'
  ],
  
  // ========================================
  // TOURIST / VISITOR QUESTIONS (80+ questions)
  // ========================================
  
  attractions: [
    'What are the absolute must-visit places in Kurukshetra?',
    'Tell me everything about Kurukshetra Panorama and Science Centre',
    'What can I see at the Krishna Museum?',
    'Where is Sheikh Chilli\'s Tomb and what\'s its history?',
    'What attractions are there at Kurukshetra University campus?',
    'Are there light and sound shows at any monuments?',
    'Which historical monuments have the most significance?',
    'What are the entry fees and timings of major tourist sites?',
    'Is there a Kurukshetra heritage walk or tour?',
    'What are the photo-worthy spots for tourists?'
  ],
  
  travel: [
    'What is the fastest way to reach Kurukshetra from Delhi?',
    'Which is the nearest airport and how far is it?',
    'Are there direct trains to Kurukshetra from major cities?',
    'How long does it take to reach from Chandigarh?',
    'What local transport options are available within the city?',
    'Can I hire a taxi or cab for full-day city tour?',
    'Are auto-rickshaws metered or do I need to bargain?',
    'Where can I rent a bike, scooter or car?',
    'Is Uber or Ola available in Kurukshetra?',
    'What is the approximate cost of local transportation?'
  ],
  
  accommodation: [
    'What are the top-rated hotels in Kurukshetra?',
    'Are there budget-friendly accommodation options under Rs 1000?',
    'Which hotels are closest to Brahma Sarovar?',
    'Do I need to book hotels well in advance?',
    'Are there any luxury resorts or heritage hotels?',
    'Which area or locality is best for tourist stay?',
    'Do hotels provide pick-up service from railway station?',
    'What are the average hotel rates per night?',
    'Are there homestays or guest houses available?',
    'Which hotels have the best reviews from travelers?'
  ],
  
  food: [
    'What are the famous local food items of Kurukshetra?',
    'Where can I find authentic pure vegetarian meals?',
    'Which are the best restaurants near major temples?',
    'What is special about Haryanvi cuisine?',
    'Where can I try prasad and temple food?',
    'Are there good South Indian restaurants here?',
    'What street food is safe and recommended to try?',
    'Do restaurants offer home delivery to hotels?',
    'Which restaurants are open late night?',
    'Where can I find Jain food without onion-garlic?'
  ],
  
  activities: [
    'What recreational activities can tourists do here?',
    'Are professional guided heritage tours available?',
    'Can I visit tourist sites during night time?',
    'What is the timing and cost of light and sound show?',
    'Are there boating facilities at any of the sarovars?',
    'Can I attend cultural programs and folk performances?',
    'Are photography tours or workshops organized?',
    'What activities are suitable for kids and families?',
    'Are there any adventure sports or activities?',
    'Can I take cooking classes for local cuisine?'
  ],
  
  shopping: [
    'What are the best souvenirs to buy from Kurukshetra?',
    'Where is the main shopping market and bazaar?',
    'Can I buy religious idols, books and artifacts?',
    'What traditional handicrafts are available here?',
    'Where to buy Bhagavad Gita in different languages?',
    'What are typical Haryanvi items to purchase?',
    'What make good gifts to take back from Kurukshetra?',
    'Are markets open all seven days or closed on specific days?',
    'Can I bargain at local markets and shops?',
    'Where to buy authentic rudraksha and spiritual items?'
  ],
  
  timing: [
    'What is the absolute best time to visit Kurukshetra?',
    'How is the weather during different seasons?',
    'When do maximum number of pilgrims visit?',
    'Is monsoon season good or bad for visiting?',
    'What is the temperature range in summer months?',
    'When are major religious festivals celebrated?',
    'What is the ideal season for comfortable sightseeing?',
    'When should I avoid visiting due to crowds?',
    'What is the temperature in winter season?',
    'Which months have pleasant weather conditions?'
  ],
  
  itinerary: [
    'Can you suggest a well-planned 1-day tour of Kurukshetra?',
    'What can I realistically cover in a weekend trip?',
    'Please plan a detailed 2-day pilgrimage itinerary',
    'How to see all major sites if I have only one day?',
    'What should I prioritize if I have only 4-5 hours?',
    'Suggest a family-friendly 2-day itinerary with kids',
    'Which sites should first-time visitors absolutely not miss?',
    'Can I combine Kurukshetra with Thanesar in one trip?',
    'What is a good 3-day comprehensive tour plan?',
    'How to plan if I want both pilgrimage and sightseeing?'
  ],
  
  // ========================================
  // STUDENT / RESEARCHER QUESTIONS (80+ questions)
  // ========================================
  
  mahabharata: [
    'What is Kurukshetra\'s exact connection to the Mahabharata war?',
    'Where precisely was the Kurukshetra battlefield located?',
    'What major events of Mahabharata happened at this place?',
    'Who were the main warriors and characters in Kurukshetra war?',
    'How many days did the great Mahabharata war last?',
    'What was the ultimate outcome and casualties of the war?',
    'Are there any war relics, artifacts or archaeological evidence?',
    'Which specific places are directly mentioned in Mahabharata text?',
    'What role did Lord Krishna play in the Kurukshetra war?',
    'How historically accurate is the Mahabharata account?'
  ],
  
  archaeology: [
    'What significant archaeological findings have been made here?',
    'Tell me about major excavations conducted in Kurukshetra',
    'What ancient artifacts and relics were discovered?',
    'Are there museums displaying archaeological collections?',
    'How old is the documented civilization of Kurukshetra?',
    'What physical evidence of Mahabharata era has been found?',
    'Which sites are protected and maintained by ASI?',
    'Can students and researchers visit active excavation sites?',
    'What carbon dating results exist for artifacts?',
    'Are there any controversial or disputed findings?'
  ],
  
  scriptures: [
    'Which Hindu scriptures and texts mention Kurukshetra?',
    'Where can I study Bhagavad Gita in depth with scholars?',
    'What ancient Vedic texts reference this sacred land?',
    'Are there specialized Vedic research centers here?',
    'What resources are available in Kurukshetra University library?',
    'Can researchers access rare manuscript collections?',
    'Which Puranas have detailed descriptions of Kurukshetra?',
    'Are Sanskrit scholars available for consultation?',
    'What academic courses focus on Gita and scriptures?',
    'Where can I find comparative scripture analysis?'
  ],
  
  culture: [
    'What is the unique cultural significance of Kurukshetra?',
    'Tell me about indigenous folk traditions and customs',
    'What traditional art forms are practiced here?',
    'What is the linguistic and cultural heritage?',
    'How has local culture evolved over centuries?',
    'What festivals best represent the cultural identity?',
    'Are there any tribal or indigenous museums?',
    'What makes Haryanvi culture distinct in this region?',
    'How does religious culture blend with daily life?',
    'What cultural preservation efforts are ongoing?'
  ],
  
  astronomy: [
    'Why is Kurukshetra astronomically significant for solar eclipses?',
    'What makes this location special for celestial observations?',
    'When do solar eclipses typically occur here?',
    'What is the historical tradition of eclipse bathing?',
    'Are there any observatories or planetariums?',
    'How do eclipses affect pilgrimage and religious activities?',
    'What scientific studies have been conducted here?',
    'Why is it historically called the land of eclipses?',
    'What ancient astronomical calculations reference this place?',
    'Are there any unique astronomical phenomena here?'
  ],
  
  education: [
    'What undergraduate and postgraduate courses does KU offer?',
    'Are there specialized research facilities for students?',
    'Tell me about National Institute of Technology Kurukshetra',
    'What educational and career opportunities exist here?',
    'Can I access academic libraries as external researcher?',
    'Are research scholarships and grants available?',
    'What departments focus on heritage and cultural studies?',
    'Can international students pursue research here?',
    'What are admission requirements and procedures?',
    'Are there distance learning or online courses?'
  ],
  
  research: [
    'What active research centers are operational here?',
    'Can I access museum archives for academic research?',
    'Are grants available for heritage research projects?',
    'Where can I find historical documents and records?',
    'What collaboration opportunities exist with institutions?',
    'Can I conduct interviews with local scholars and experts?',
    'Are research papers and journals published regularly?',
    'What digital archives and databases are accessible?',
    'How do I get permission for field research?',
    'Are there annual academic conferences or seminars?'
  ],
  
  history: [
    'What is the complete chronological historical timeline?',
    'How did Kurukshetra develop and evolve through ages?',
    'What are the distinct major historical periods?',
    'Which dynasties and empires ruled this region?',
    'What significant events occurred in medieval period?',
    'How did British colonial period impact Kurukshetra?',
    'What happened during independence movement here?',
    'What is the post-independence development history?',
    'How has urbanization changed the landscape?',
    'What historical preservation challenges exist today?'
  ],
  
  // ========================================
  // RESIDENT / CITIZEN QUESTIONS (80+ questions)
  // ========================================
  
  services: [
    'Where is the Municipal Corporation main office located?',
    'How do I apply for birth certificate online and offline?',
    'What are all property tax payment options available?',
    'Where and how to register complaints about civic issues?',
    'How to apply for new utility connections?',
    'What are government office timings and weekly offs?',
    'How to apply for trade license for business?',
    'Where is the SDM office and what services provided?',
    'How to get domicile certificate of Kurukshetra?',
    'What documents needed for various certificates?'
  ],
  
  healthcare: [
    'Where are the main government hospitals with facilities?',
    'What emergency medical services and ambulances available?',
    'Which are the best private hospitals in the city?',
    'Where to get COVID vaccination and booster doses?',
    'What medical facilities for cardiac and other emergencies?',
    'Are there 24-hour pharmacies and medical stores?',
    'Where is the nearest blood bank located?',
    'What ambulance services can I call in emergency?',
    'Are there specialist doctors and consultation available?',
    'What government health schemes can I avail?'
  ],
  
  education_c: [
    'What are the top-rated schools in Kurukshetra?',
    'Where is the District Education Officer located?',
    'How to get admission in government schools?',
    'What degree colleges are available for graduation?',
    'Are there good competitive exam coaching centers?',
    'What vocational training institutes operate here?',
    'How to apply for student scholarships?',
    'Where are CBSE affiliated schools located?',
    'What are admission deadlines for schools and colleges?',
    'Are there special education facilities for children?'
  ],
  
  transport: [
    'What are all city bus routes and timings?',
    'Where is the main inter-state bus terminal?',
    'How do I apply for driving license in Kurukshetra?',
    'What public transport is most reliable and frequent?',
    'Where to register newly purchased vehicles?',
    'Are prepaid taxi or auto services available?',
    'What is exact location of railway station?',
    'How to book reserved bus tickets in advance?',
    'What is monthly bus pass cost for regular commute?',
    'Are there electric vehicle charging stations?'
  ],
  
  utilities: [
    'How to pay electricity bills through online methods?',
    'Where to complain about water supply problems?',
    'What is sewage department contact for blockages?',
    'How to apply for new electricity connection?',
    'Where to report and register power outage complaints?',
    'What is local LPG gas agency contact details?',
    'How to get new piped water connection?',
    'Where is electricity sub-division complaint office?',
    'How to check and download utility bills online?',
    'What are timely payment benefits and late fees?'
  ],
  
  safety: [
    'Where are all police stations located with jurisdiction?',
    'How to file FIR or general complaint?',
    'What are emergency helpline numbers to remember?',
    'Where is women police station located?',
    'How to report crime online through portal?',
    'Where is main fire station and emergency number?',
    'What is ambulance emergency contact number?',
    'Are public areas covered by CCTV surveillance?',
    'How to report lost documents and items?',
    'What safety apps and services are available?'
  ],
  
  civic: [
    'What public parks and gardens are available for families?',
    'Where is the main public library and timings?',
    'What community centers exist for events and programs?',
    'Are there public sports facilities and stadiums?',
    'Where can I register for free yoga classes?',
    'What cultural programs are regularly organized?',
    'Are there dedicated senior citizen activity centers?',
    'Where is district court complex located?',
    'What public halls available for social functions?',
    'Are there swimming pools and gym facilities?'
  ],
  
  complaints: [
    'How to register civic complaint through online portal?',
    'What is CM Window portal procedure and access?',
    'How can I track my complaint status online?',
    'Where to complain about road potholes and damage?',
    'How to report garbage collection and sanitation issues?',
    'What is the proper grievance redressal mechanism?',
    'How long typically do complaints take to resolve?',
    'Can I file complaints anonymously without revealing identity?',
    'What to do if complaint is not resolved in time?',
    'How to escalate unresolved complaints to higher authority?'
  ]
};    
    // FIXED: Proper radio button handling
function selectQueryType(type) {
  selectedQueryType = type;

  // Toggle radio cards
  document.querySelectorAll('.radio-option')
    .forEach(el => el.classList.remove('selected'));

  if (type === 'custom') {
    document.getElementById('customCard')?.classList.add('selected');
    document.getElementById('customQuestionDiv').style.display = 'block';
    document.getElementById('readyQuestionDiv').style.display = 'none';
    // Hide Get Answer button (we have Send button in input)
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) submitBtn.style.display = 'none';

    // ğŸ”¹ Refinement 2: Auto-focus cursor
   setTimeout(() => {
  const input = document.getElementById('userInput');
  if (input) {
    input.value = '';   // clear old ready-made question
    input.focus();      // focus for fresh input
  }
}, 200);
  } else {
    document.getElementById('readyCard')?.classList.add('selected');
    document.getElementById('customQuestionDiv').style.display = 'none';
    document.getElementById('readyQuestionDiv').style.display = 'block';
// Show Get Answer button (no Send button in ready-made)
  const submitBtn = document.getElementById('submitBtn');
  if (submitBtn) submitBtn.style.display = 'block';
    loadTopics(selectedUser);
    document.getElementById('topicSection').style.display = 'block';
  }

  /* ================================
     Refinement 1: Auto-collapse selector
     ================================ */
  setTimeout(() => {
    const selector = document.querySelector('.query-type-selector');
    const summary = document.getElementById('queryTypeSummary');
    const text = document.getElementById('queryTypeSummaryText');

    const labels = {
      custom: 'Ask Your Own Question',
      ready: 'Ready-Made Questions'
    };

if (selector && summary && text) {
  selector.style.display = 'none';
  summary.style.display = 'flex';
  text.textContent = labels[type];
}
  }, 300);
}

    
    window.selectQueryType = selectQueryType;

   // Select main user profile (always visible)
// Select main user profile (USER ACTION ONLY)
function selectMainUser(userType) {
  selectedUser = userType;

  // âœ… Mark as manually changed
  isProfileManuallyChanged = true;

  // Update profile cards
  document.querySelectorAll('.user-card-small')
    .forEach(el => el.classList.remove('selected'));

  const mainCard = document.getElementById(
    'user' + userType.charAt(0).toUpperCase() + userType.slice(1) + 'Main'
  );
  if (mainCard) mainCard.classList.add('selected');

  // âœ… Update hint ONLY for manual selection
  const hintEl = document.getElementById('profileHint');
  const shortNames = {
    police: 'Pilgrim / Devotee',
    legal: 'Tourist / Visitor',
    student: 'Student / Researcher',
    citizen: 'Resident / Citizen'
  };

  if (hintEl) {
    hintEl.textContent = 'âœ“ Selected: ' + (shortNames[userType] || 'Resident / Citizen');
  }

  /* ================================
     Progressive Collapse Logic
     (UNCHANGED â€“ USER FLOW)
     ================================ */
  setTimeout(() => {
    const profileBox = document.getElementById('profileSelector');
    const summaryBox = document.getElementById('profileSummary');
    const summaryText = document.getElementById('profileSummaryText');

    if (profileBox && summaryBox && summaryText) {
      profileBox.classList.add('hidden');
      summaryBox.classList.remove('hidden');
      summaryText.textContent = shortNames[userType] || 'Resident / Citizen';
    }

    // Scroll to next section
    const nextSection = document.querySelector('.query-type-selector');
    if (nextSection) {
      nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 300);

  // Load ready-made topics if visible
  const readyDiv = document.getElementById('readyQuestionDiv');
  if (readyDiv && readyDiv.style.display !== 'none') {
    loadTopics(userType);
    document.getElementById('topicSection').style.display = 'block';
  }
// Auto-select appropriate topic when user changes profile
    setTimeout(() => {
      autoSelectTopicForUserType();
    }, 300);
  console.log('âœ… User manually selected profile:', userType);
}

    
    window.selectMainUser = selectMainUser;

    function selectUser(userType) {
      // This function is now deprecated - selectMainUser handles everything
      selectMainUser(userType);
    }
    
    window.selectUser = selectUser;

    function loadTopics(userType) {
      const container = document.getElementById('topicContainer');
      container.innerHTML = '';
      
      const topics = TOPICS[userType] || [];
      
      topics.forEach(function(topic) {
        const topicCard = document.createElement('div');
        topicCard.className = 'topic-card';
        topicCard.id = 'topic-' + topic.id;
        topicCard.onclick = function() { selectTopic(topic.id); };
        
        topicCard.innerHTML = '<div class="topic-icon">' + topic.icon + '</div>' +
          '<div class="flex-1">' +
          '<div class="topic-title">' + topic.title + '</div>' +
          '<div class="topic-subtitle">' + topic.subtitle + '</div>' +
          '<div class="topic-law">' + topic.law + '</div>' +
          '</div>';
        
        container.appendChild(topicCard);
      });
    }

    function selectTopic(topicId) {
      selectedTopic = topicId;
      
      // Update UI
      document.querySelectorAll('.topic-card').forEach(function(el) {
        el.classList.remove('selected');
      });
      const topicCard = document.getElementById('topic-' + topicId);
      if (topicCard) topicCard.classList.add('selected');
      
      // Load questions for this topic
      loadQuestionsForTopic(topicId);
      
      // Show question section
      document.getElementById('questionSelectSection').style.display = 'block';
      
      console.log('âœ… Topic selected:', topicId);
    }

function loadQuestionsForTopic(topicId) {
  const questionSelect = document.getElementById('questionSelect');
  questionSelect.innerHTML = '<option value="" selected disabled>Tap to select a question...</option>';
  
  const questions = TOPIC_QUESTIONS[topicId] || [];
  
  questions.forEach(function(q) {
    const option = document.createElement('option');
    option.value = q;
    option.textContent = q;
    questionSelect.appendChild(option);
  });
}


    document.getElementById('questionSelect').addEventListener('change', function() {
      document.getElementById('userInput').value = this.value;
    });

// Voice recognition
let recognition;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = function () {
    isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
  };

  recognition.onresult = function (event) {
    document.getElementById('userInput').value =
      event.results[0][0].transcript;
  };

  recognition.onend = function () {
    isRecording = false;
    document.getElementById('voiceBtn').classList.remove('recording');
  };

  recognition.onerror = function () {
    isRecording = false;
    document.getElementById('voiceBtn').classList.remove('recording');
  };
}

document.getElementById('voiceBtn').addEventListener('click', function (e) {
  e.preventDefault();

  if (!recognition) {
    alert('Voice recognition not supported');
    return;
  }

  if (isRecording) {
    recognition.stop();
    return;
  }

  // âœ… SET LANGUAGE JUST BEFORE START
  // Get language from whichever selector is visible
const langCustom = document.getElementById('languageSelect')?.value;
const langReady = document.getElementById('languageSelectReady')?.value;
const lang = langCustom || langReady || 'english';

  if (lang === 'hindi') recognition.lang = 'hi-IN';
  else if (lang === 'punjabi') recognition.lang = 'pa-IN';
  else recognition.lang = 'en-IN';

  recognition.start();
});

document.getElementById('submitBtn').addEventListener('click', async function() {
  // Get question from textarea
  const question = document.getElementById('userInput').value.trim();
  
  // Validate question
  if (!question) {
    alert('à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚! / Please enter your question!');
    return;
  }
  
  // Check if simple mode - use chat interface
  if (currentMode === 'simple') {
    // Open chat interface
    document.getElementById('chatInterface').classList.add('active');
    
    // Transfer question to chat input and send
    document.getElementById('chatInput').value = question;
    sendChatMessage();
    document.getElementById('userInput').value = ''; // Clear original input
    return;
  }
  
  // POWER MODE - Continue with modal logic below
  
  // Profile is always selected (default: citizen)
  // Show gentle reminder if user hasn't explicitly selected
  if (selectedUser === 'citizen' && !document.getElementById('userCitizenMain').classList.contains('selected')) {
    console.log('â„¹ï¸ Using default profile: Resident / Citizen');
  }
  
  // Reset for new question
  currentQuestion = question;
  currentAnswerLevel = 'standard'; // Default to standard
  aiUsed = { groq: false, chatgpt: true };
  
  // Call API with ChatGPT and standard depth
  await getAnswer('chatgpt', 'standard');
});

document.getElementById('closeModal').addEventListener('click', function() {
  speechSynthesis.cancel();   // ğŸ”‡ Stop listening
  stopListeningUI();
  document.getElementById('aiModal').classList.add('hidden');
});

document.getElementById('closeBtn').addEventListener('click', function() {
  speechSynthesis.cancel();   // ğŸ”‡ Stop listening
  stopListeningUI();
  document.getElementById('aiModal').classList.add('hidden');
});


    // Extract Keywords from User's Question
    function extractKeywords(question) {
      // Convert to lowercase for processing
      const text = question.toLowerCase();
      
      // Remove common question words
      const stopWords = ['what', 'when', 'where', 'how', 'why', 'who', 'is', 'are', 'the', 'a', 'an', 
                         'can', 'could', 'should', 'would', 'do', 'does', 'did', 'have', 'has', 'had',
                         'will', 'shall', 'may', 'might', 'must', 'à¤•à¥‹', 'à¤•à¤¾', 'à¤•à¥‡', 'à¤®à¥‡à¤‚', 'à¤¸à¥‡', 'à¤¹à¥ˆ', 'à¤¹à¥ˆà¤‚'];
      
      // Split into words and filter
      const words = text.split(/\s+/)
        .filter(word => word.length > 2)  // At least 3 characters
        .filter(word => !stopWords.includes(word))
        .filter(word => !/^\d+$/.test(word));  // Remove pure numbers
      
      // Take first 4-5 meaningful words as keywords
      const keywords = words.slice(0, 5);
      
      // If we have very few keywords, try to extract key phrases
      if (keywords.length < 3) {
        // Look for important legal terms
        const importantTerms = [
          'arrest', 'bail', 'fir', 'complaint', 'investigation', 'search', 'seizure',
          'evidence', 'witness', 'trial', 'court', 'judge', 'lawyer', 'police',
          'custody', 'detention', 'rights', 'punishment', 'crime', 'offence',
          'murder', 'theft', 'fraud', 'rape', 'kidnapping', 'cybercrime',
          'electronic', 'digital', 'cyber', 'appeal', 'revision', 'judgment',
          'charge', 'chargesheet', 'confession', 'anticipatory', 'cognizable',
          'bailable', 'warrant', 'summons', 'victim', 'compensation'
        ];
        
        importantTerms.forEach(term => {
          if (text.includes(term) && !keywords.includes(term)) {
            keywords.push(term);
          }
        });
      }
      
      return keywords.filter((v, i, a) => a.indexOf(v) === i); // Remove duplicates
    }

    // Open Section Search with Keywords from Question
    function openSectionSearch() {
      // Get the original question
      const question = document.getElementById('modalQuestion').textContent;
      
      if (question && question.trim()) {
        // Extract keywords from the question
        const keywords = extractKeywords(question);
        
        if (keywords.length > 0) {
          // Build URL with keywords
          const searchQuery = keywords.join('+');
          const url = 'section-search.html?search=' + encodeURIComponent(searchQuery);
          window.open(url, '_blank');
          console.log('âœ… Opening section search with keywords:', keywords.join(' '));
        } else {
          // Fallback: open without keywords
          window.open('section-search.html', '_blank');
          console.log('âš ï¸ No keywords extracted, opening section search');
        }
      } else {
        // No question available, just open section search
        window.open('section-search.html', '_blank');
        console.log('âœ… Opening section search (no question available)');
      }
    }
    
    window.openSectionSearch = openSectionSearch;

    // Ask a Related Question
    function askRelatedQuestion(question) {
      console.log('ğŸ“‹ Related question clicked:', question);
      console.log('ğŸ“‹ Auto-submitting related question...');
      
      // Close the modal first
      document.getElementById('aiModal').classList.add('hidden');
      
      // Set the question in the input
      document.getElementById('userInput').value = question;
      
      // Update current question
      currentQuestion = question;
      
      // Scroll to input
      document.getElementById('userInput').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Brief highlight
      const input = document.getElementById('userInput');
      input.style.backgroundColor = '#fef3c7';
      input.focus();
      
      // AUTO-SUBMIT after short delay
      setTimeout(() => {
        input.style.backgroundColor = '';
        console.log('ğŸš€ Auto-submitting question now...');
        // Trigger the answer
        getAnswer('chatgpt', 'standard');
      }, 800);  // 800ms delay to show the question briefly
    }
    
    window.askRelatedQuestion = askRelatedQuestion;

    // Autocomplete Suggestions for Custom Questions
    function showAutocompleteSuggestions() {
      const input = document.getElementById('userInput');
      const suggestionsBox = document.getElementById('autocompleteSuggestions');
      const query = input.value.toLowerCase().trim();
      
      // Hide if input is too short
      if (query.length < 3) {
        suggestionsBox.classList.add('hidden');
        return;
      }
      
      // Get all questions from TOPIC_QUESTIONS
      const allQuestions = [];
      for (const topic in TOPIC_QUESTIONS) {
        allQuestions.push(...TOPIC_QUESTIONS[topic]);
      }
      
      // Filter matching questions
      const matches = allQuestions.filter(q => 
        q.toLowerCase().includes(query)
      ).slice(0, 10); // Limit to 10 suggestions
      
      // Show suggestions
      if (matches.length > 0) {
        suggestionsBox.innerHTML = matches.map(q => `
          <div class="p-3 hover:bg-orange-50 cursor-pointer border-b border-orange-100 text-sm transition"
               onclick="selectSuggestion('${q.replace(/'/g, "\\'")}')">
            ${q}
          </div>
        `).join('');
        suggestionsBox.classList.remove('hidden');
      } else {
        suggestionsBox.classList.add('hidden');
      }
    }
    
    function selectSuggestion(question) {
      const input = document.getElementById('userInput');
      const suggestionsBox = document.getElementById('autocompleteSuggestions');
      
      input.value = question;
      suggestionsBox.classList.add('hidden');
      input.focus();
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
      const suggestionsBox = document.getElementById('autocompleteSuggestions');
      const input = document.getElementById('userInput');
      
      if (!suggestionsBox.contains(event.target) && event.target !== input) {
        suggestionsBox.classList.add('hidden');
      }
    });
    
    console.log('âœ… KURUKSHETRA MITRA ready with autocomplete!');
function expandProfileSelector() {
  document.getElementById('profileSelector')?.classList.remove('hidden');
  document.getElementById('profileSummary')?.classList.add('hidden');
}
function expandQueryType() {
  const selector = document.querySelector('.query-type-selector');
  const summary = document.getElementById('queryTypeSummary');

if (selector && summary) {
  selector.style.display = 'block';
  summary.style.display = 'none';
}

  // ğŸ”¹ FIX: Restore correct radio & visual selection
  document.querySelectorAll('.radio-option')
    .forEach(el => el.classList.remove('selected'));

  const customRadio = document.querySelector('input[name="queryType"][value="custom"]');
  const readyRadio = document.querySelector('input[name="queryType"][value="ready"]');

  if (selectedQueryType === 'custom') {
    customRadio.checked = true;
    document.getElementById('customCard')?.classList.add('selected');
  } else {
    readyRadio.checked = true;
    document.getElementById('readyCard')?.classList.add('selected');
  }
}
function toggleAdvancedFooter() {
  const panel = document.getElementById('advancedFooter');
  const arrow = document.getElementById('advFooterArrow');

  panel.classList.toggle('hidden');
  arrow.textContent = panel.classList.contains('hidden') ? 'â–¾' : 'â–´';
}



  </script>
<script>
  function disableResponseActions() {
  ['whatsappBtn', 'listenBtn', 'searchBtn'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.disabled = true;
      btn.classList.add('opacity-40', 'cursor-not-allowed');
    }
  });
}

function enableResponseActions() {
  ['whatsappBtn', 'listenBtn', 'searchBtn'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.disabled = false;
      btn.classList.remove('opacity-40', 'cursor-not-allowed');
    }
  });
}

  function shareOnWhatsApp() {
    console.log('âœ… shareOnWhatsApp reached');

    const response = document.getElementById('modalAnswer');
    if (!response) {
      alert('modalAnswer not found');
      return;
    }

    const text = response.innerText.trim();
    if (!text) {
      alert('Answer empty');
      return;
    }

    window.open(
      'https://wa.me/?text=' + encodeURIComponent(text),
      '_blank'
    );
  }
  disableResponseActions();
</script>
<script>
  let isListening = false;
  let currentUtterance = null;

  function toggleListen() {
    const response = document.getElementById('modalAnswer');
    if (!response) {
      alert('No response available to listen.');
      return;
    }

    // ğŸ” If already speaking â†’ STOP
    if (speechSynthesis.speaking || isListening) {
      speechSynthesis.cancel();
      stopListeningUI();
      return;
    }

    const text = response.innerText.trim();
    if (!text) {
      alert('Response is empty.');
      return;
    }

    currentUtterance = new SpeechSynthesisUtterance(text);

    // Language sync
  // Get language from whichever selector is visible
const langCustom = document.getElementById('languageSelect')?.value;
const langReady = document.getElementById('languageSelectReady')?.value;
const lang = langCustom || langReady || 'english';
    if (lang === 'hindi') currentUtterance.lang = 'hi-IN';
    else if (lang === 'punjabi') currentUtterance.lang = 'pa-IN';
    else currentUtterance.lang = 'en-IN';

    currentUtterance.rate = 0.95;
    currentUtterance.pitch = 1;
    currentUtterance.volume = 1;

    currentUtterance.onend = () => {
      stopListeningUI();
    };

    isListening = true;
    updateListeningUI(true);
    speechSynthesis.speak(currentUtterance);
  }

function updateListeningUI(active) {
  const btn = document.getElementById('listenBtn');

  document.getElementById('listenIconPlay').classList.toggle('hidden', active);
  document.getElementById('listenIconStop').classList.toggle('hidden', !active);

  document.getElementById('listenIndicator').classList.toggle('hidden', !active);

  btn.classList.toggle('bg-purple-600', !active);
  btn.classList.toggle('bg-red-600', active);

  isListening = active;
}


  function stopListeningUI() {
    updateListeningUI(false);
    isListening = false;
  }

  // Mode Toggle Functionality
let currentMode = 'simple'; // Default mode

function toggleMode() {
  const toggle = document.getElementById('modeToggle');
  const simpleLabel = document.getElementById('simpleModeLabel');
  const powerLabel = document.getElementById('powerModeLabel');
  
  if (currentMode === 'simple') {
    // Switch to Power mode
    currentMode = 'power';
    toggle.classList.add('power');
    simpleLabel.classList.remove('active');
    powerLabel.classList.add('active');
    document.body.classList.remove('simple-mode');
    
    console.log('ğŸ”¥ Switched to POWER MODE');
    
  } else {
    // Switch to Simple mode
    currentMode = 'simple';
    toggle.classList.remove('power');
    simpleLabel.classList.add('active');
    powerLabel.classList.remove('active');
    document.body.classList.add('simple-mode');
    
    // Auto-select custom query type in simple mode
   selectQueryType('ready');
autoSelectTopicForUserType();
    
    console.log('âœ¨ Switched to SIMPLE MODE');
  }
  
  // Save preference
  localStorage.setItem('Kurukshetra MitraMode', currentMode);
}

// Simple Profile Selector
function selectSimpleUser(userType) {
  selectedUser = userType;
  
  const icons = {
    citizen: 'ğŸ§‘â€ğŸ’¼',
    student: 'ğŸ“',
    police: 'ğŸ™',
    legal: 'ğŸ•‰'
  };
  
  document.getElementById('simpleProfileIcon').textContent = icons[userType];
  
  // Also update the main profile selector in case user switches to power mode
  selectMainUser(userType);
  
  console.log('Simple mode - Selected user:', userType);
}

// Initialize mode on page load
window.addEventListener('DOMContentLoaded', function() {
  const savedMode = localStorage.getItem('Kurukshetra MitraMode');
  
  // Start in simple mode by default
  document.body.classList.add('simple-mode');
  
  if (savedMode === 'power') {
    toggleMode(); // Switch to power mode if previously selected
  }
});
// Chat Interface Functions
function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const question = input.value.trim();
  
  if (!question) {
    // Shake animation for empty input
    input.classList.add('border-red-400');
    input.placeholder = 'âš ï¸ Please type a question...';
    input.focus();
    
    setTimeout(() => {
      input.classList.remove('border-red-400');
      input.placeholder = 'ğŸ’¬ Type your question...';
    }, 2000);
    
    return;
  }
  
  // Add user message to chat
  addChatMessage(question, 'user');
  
  // Clear input
  input.value = '';
  
// Set current question for API call
currentQuestion = question;
lastQuestion = question; // Track for retry
  
  // Show typing indicator
  addTypingIndicator();
  
  // Call existing getAnswer function but display in chat
  getAnswerForChat('chatgpt', 'standard');
}

function addChatMessage(text, type) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  
  if (type === 'user') {
    messageDiv.className = 'flex gap-3 items-start justify-end';
    messageDiv.innerHTML = `
      <div class="chat-bubble-user rounded-2xl rounded-tr-none shadow-md p-4">
        <p class="text-sm">${escapeHtml(text)}</p>
        <p class="text-xs mt-2 opacity-75">${getCurrentTime()}</p>
      </div>
      <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-white flex-shrink-0">
        ğŸ‘¤
      </div>
    `;
} else {
  messageDiv.className = 'flex gap-3 items-start';
  messageDiv.innerHTML = `
    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
      ğŸ•‰
    </div>
    <div class="chat-bubble-bot rounded-2xl rounded-tl-none shadow-md p-4">
      <div class="text-sm text-gray-800" id="botMessage-${Date.now()}">${formatBotMessage(text)}</div>
      <p class="text-xs mt-2 text-gray-400">${getCurrentTime()}</p>
      
      <!-- Action Buttons -->
      <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
<button onclick="listenToBotMessage(this)" class="flex items-center gap-1 px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-xs font-medium transition">          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 000 12.728M12 12h.01"/>
          </svg>
          Listen
        </button>
        
<button onclick="copyBotMessage(this)" class="flex items-center gap-1 px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-xs font-medium transition">          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Copy
        </button>
        
        <button onclick="shareOnWhatsAppChat(this)" class="flex items-center gap-1 px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-xs font-medium transition">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          Share
</button>
      </div>
      
      <!-- Quick Suggestion Chips -->
      <div class="mt-3 pt-3 border-t border-gray-100" id="suggestions-${Date.now()}">
        <p class="text-xs text-gray-500 mb-2">ğŸ’¡ Related questions:</p>
        <div class="flex flex-wrap gap-2">
          <!-- Suggestions will be added dynamically -->
        </div>
      </div>
    </div>
  `;
}
  
chatMessages.appendChild(messageDiv);
smoothScrollToBottom();
updateChatMessageCount();
return messageDiv; // Return the created element
}
// Update Chat Message Count
function updateChatMessageCount() {
  const chatMessages = document.getElementById('chatMessages');
  const userMessages = chatMessages.querySelectorAll('.chat-bubble-user').length;
  const botMessages = chatMessages.querySelectorAll('.chat-bubble-bot').length;
  const headerStatus = document.getElementById('chatHeaderStatus');
  
  if (userMessages > 0) {
    headerStatus.textContent = `${userMessages + botMessages} messages â€¢ Online`;
  } else {
    headerStatus.textContent = 'AI Heritage Guide â€¢ Online';
  }
}
function addTypingIndicator() {
  const chatMessages = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typingIndicator';
  typingDiv.className = 'flex gap-3 items-start';
  typingDiv.innerHTML = `
    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-full flex items-center justify-center text-white flex-shrink-0 animate-pulse">
      ğŸ•‰
    </div>
    <div class="bg-white rounded-2xl rounded-tl-none shadow-md p-4">
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <p class="text-xs text-gray-400 mt-2">Kurukshetra Mitra is thinking...</p>
    </div>
  `;
  chatMessages.appendChild(typingDiv);
  smoothScrollToBottom();
}
// Smooth Scroll to Bottom
function smoothScrollToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.scrollTo({
    top: chatMessages.scrollHeight,
    behavior: 'smooth'
  });
}

function removeTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.remove();
}

function closeChatInterface() {
  document.getElementById('chatInterface').classList.remove('active');
}

// Modified getAnswer for chat mode
async function getAnswerForChat(provider, answerLevel = 'standard') {
  try {
    const selectedLanguage = document.getElementById('languageSelect').value;
    
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: currentQuestion,
        provider: provider,
        userType: selectedUser,
        answerDepth: answerLevel,
        language: selectedLanguage,
        timestamp: new Date().toISOString()
      })
    });
    
    if (!response.ok) throw new Error('HTTP ' + response.status);
    
    let data = await response.json();
    
    // Extract answer
    if (Array.isArray(data) && data.length > 0) {
      data = data[0];
    }
    
    let answerText = '';
    if (typeof data === 'string') {
      answerText = data;
    } else if (data && data.answer) {
      answerText = data.answer;
    } else if (data && data.response) {
      answerText = data.response;
    } else {
      answerText = 'Sorry, I could not generate a response.';
    }
    
   // Remove typing indicator and add bot response
removeTypingIndicator();
const botMessageDiv = addChatMessage(answerText, 'bot');

// Add smart suggestions after a brief delay
setTimeout(() => {
  if (botMessageDiv) {
    addSmartSuggestions(botMessageDiv, currentQuestion);
  }
}, 500);
    
} catch (error) {
  console.error('Error:', error);
  removeTypingIndicator();
  
  // Determine error type
  let errorMessage = '';
  let showRetry = false;
  
  if (!navigator.onLine) {
    errorMessage = 'ğŸ”Œ <strong>No internet connection</strong><br><br>Please check your network and try again.';
    showRetry = true;
  } else if (error.message.includes('HTTP')) {
    errorMessage = 'âš ï¸ <strong>Server error</strong><br><br>The AI service is temporarily unavailable. Please try again in a moment.';
    showRetry = true;
  } else {
    errorMessage = 'âŒ <strong>Something went wrong</strong><br><br>Please try asking your question again.';
    showRetry = true;
  }
  
  // Add error message
  const errorDiv = addChatMessage(errorMessage, 'bot');
  
  // Add retry button if applicable
  if (showRetry && errorDiv) {
    const retryButton = document.createElement('div');
    retryButton.className = 'mt-3 pt-3 border-t border-gray-100';
    retryButton.innerHTML = `
      <button onclick="retryLastQuestion()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Retry
      </button>
    `;
    const botMessage = errorDiv.querySelector('.chat-bubble-bot');
    if (botMessage) {
      botMessage.appendChild(retryButton);
    }
  }
}
}
// Retry Last Question
let lastQuestion = '';

function retryLastQuestion() {
  if (lastQuestion) {
    document.getElementById('chatInput').value = lastQuestion;
    sendChatMessage();
  }
}
// Utility functions
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
}

function formatBotMessage(text) {
  // Convert newlines to <br>
  text = text.replace(/\n/g, '<br>');
  // Convert **bold** to <strong>
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Convert markdown links
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-purple-600 underline">$1</a>');
  return text;
}
// Chat Action Functions
let currentSpeech = null;

function listenToBotMessage(button) {
  const messageDiv = button.closest('.chat-bubble-bot');
  const messageText = messageDiv.querySelector('[id^="botMessage-"]').innerText;
  
  // Stop if already speaking
  if (currentSpeech && speechSynthesis.speaking) {
    speechSynthesis.cancel();
    button.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 000 12.728M12 12h.01"/>
      </svg>
      Listen
    `;
    currentSpeech = null;
    return;
  }
  
  // Start speaking
  currentSpeech = new SpeechSynthesisUtterance(messageText);
  
  // Set language based on selection
// Get language from whichever selector is visible
const langCustom = document.getElementById('languageSelect')?.value;
const langReady = document.getElementById('languageSelectReady')?.value;
const lang = langCustom || langReady || 'english';
  if (lang === 'hindi') currentSpeech.lang = 'hi-IN';
  else if (lang === 'punjabi') currentSpeech.lang = 'pa-IN';
  else currentSpeech.lang = 'en-IN';
  
  currentSpeech.rate = 0.9;
  currentSpeech.pitch = 1;
  
  // Update button during speech
  button.innerHTML = `
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
    </svg>
    Stop
  `;
  
  currentSpeech.onend = () => {
    button.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 000 12.728M12 12h.01"/>
      </svg>
      Listen
    `;
    currentSpeech = null;
  };
  
  speechSynthesis.speak(currentSpeech);
}

function copyBotMessage(button) {
  const messageDiv = button.closest('.chat-bubble-bot');
  const messageText = messageDiv.querySelector('[id^="botMessage-"]').innerText;
  
  navigator.clipboard.writeText(messageText).then(() => {
    // Show success feedback
    const originalHTML = button.innerHTML;
    button.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      Copied!
    `;
    button.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
    button.classList.add('bg-green-100', 'text-green-700');
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('bg-green-100', 'text-green-700');
      button.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
    }, 2000);
  }).catch(err => {
    console.error('Copy failed:', err);
    alert('Failed to copy text');
  });
}

function shareOnWhatsAppChat(button) {
  const messageDiv = button.closest('.chat-bubble-bot');
  const messageText = messageDiv.querySelector('[id^="botMessage-"]').innerText;
  
  const shareText = `*Kurukshetra Mitra Answer:*\n\n${messageText}\n\n_Powered by Kurukshetra Mitra - AI Heritage Guide_`;
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
  
  window.open(whatsappUrl, '_blank');
}

// Smart Suggestion Generator
function addSmartSuggestions(messageDiv, originalQuestion) {
  const suggestionsContainer = messageDiv.querySelector('[id^="suggestions-"]');
  if (!suggestionsContainer) return;
  
  const chipsContainer = suggestionsContainer.querySelector('.flex');
  
  // Get suggestions based on question keywords
  const suggestions = getRelatedQuestions(originalQuestion);
  
  if (suggestions.length === 0) return;
  
  // Add up to 4 suggestion chips
  suggestions.slice(0, 4).forEach(question => {
    const chip = document.createElement('button');
    chip.className = 'px-3 py-1.5 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-full text-xs font-medium transition border border-purple-200';
    chip.textContent = question;
    chip.onclick = () => {
      document.getElementById('chatInput').value = question;
      sendChatMessage();
    };
    chipsContainer.appendChild(chip);
  });
}

function getRelatedQuestions(question) {
  const q = question.toLowerCase();
  
  // Topic-based suggestions
  const suggestionMap = {
    'fir': [
      'How long does it take to file FIR?',
      'Can police refuse to register FIR?',
      'What happens after FIR is filed?',
      'Can FIR be withdrawn?'
    ],
    'bail': [
      'What are bail conditions?',
      'How much time for bail hearing?',
      'Can bail be cancelled?',
      'What is anticipatory bail?'
    ],
    'arrest': [
      'What are rights during arrest?',
      'Can arrest happen without warrant?',
      'How long can police detain?',
      'What is the arrest procedure?'
    ],
    'cyber': [
      'Best hotels in Kurukshetra?',
      'What is cyber police helpline?',
      'Can money be recovered in cyber fraud?',
      'How long to report online fraud?'
    ],
    'evidence': [
      'What is electronic evidence?',
      'Can WhatsApp chats be evidence?',
      'How to prove digital records?',
      'What documents are needed?'
    ],
    'witness': [
      'Who can be a witness?',
      'Can witness refuse to testify?',
      'What is witness protection?',
      'How is witness examined?'
    ],
    'complaint': [
      'Where to file complaint?',
      'What is difference between FIR and complaint?',
      'Can complaint be filed online?',
      'How to track complaint status?'
    ],
    'investigation': [
      'How long can investigation take?',
      'What are investigation stages?',
      'Can victim participate in investigation?',
      'What if investigation is delayed?'
    ],
    'trial': [
      'How long does trial take?',
      'What happens in trial?',
      'Can trial be fast-tracked?',
      'What are stages of trial?'
    ],
    'punishment': [
      'What are types of punishment?',
      'Can punishment be reduced?',
      'What is life imprisonment?',
      'What are penalties for crimes?'
    ]
  };
  
  // Find matching topic
  for (const [keyword, questions] of Object.entries(suggestionMap)) {
    if (q.includes(keyword)) {
      return questions;
    }
  }
  
  // Default suggestions if no match
  return [
    'What are the main festivals celebrated here?',
    'How to file FIR online?',
    'What are my legal rights?',
    'How to get legal aid?'
  ];
}
// Voice Input for Chat
let chatRecognition = null;
let isChatRecording = false;

function toggleChatVoiceInput() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
    return;
  }
  
  if (isChatRecording) {
    stopChatRecording();
  } else {
    startChatRecording();
  }
}

function startChatRecording() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  chatRecognition = new SpeechRecognition();
  
  // Get language from selector
// Get language from whichever selector is visible
const langCustom = document.getElementById('languageSelect')?.value;
const langReady = document.getElementById('languageSelectReady')?.value;
const lang = langCustom || langReady || 'english';
  if (lang === 'hindi') {
    chatRecognition.lang = 'hi-IN';
  } else if (lang === 'punjabi') {
    chatRecognition.lang = 'pa-IN';
  } else {
    chatRecognition.lang = 'en-IN';
  }
  
  chatRecognition.continuous = false;
  chatRecognition.interimResults = false;
  
  // UI Updates
  const voiceBtn = document.getElementById('chatVoiceBtn');
  const statusSpan = document.getElementById('chatTypingStatus');
  
  voiceBtn.classList.add('recording');
  statusSpan.innerHTML = '<span class="recording-indicator"><span class="recording-dot"></span>Listening...</span>';
  isChatRecording = true;
  
  // Handle result
  chatRecognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chatInput').value = transcript;
    console.log('Voice input:', transcript);
  };
  
  // Handle end
  chatRecognition.onend = () => {
    stopChatRecording();
    
    // Auto-send if there's text
    const inputText = document.getElementById('chatInput').value.trim();
    if (inputText) {
      setTimeout(() => {
        sendChatMessage();
      }, 500);
    }
  };
  
  // Handle error
  chatRecognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    stopChatRecording();
    
    if (event.error === 'no-speech') {
      statusSpan.innerHTML = '<span class="text-orange-600">No speech detected. Try again.</span>';
    } else if (event.error === 'not-allowed') {
      alert('Microphone access denied. Please allow microphone permission.');
    } else {
      statusSpan.innerHTML = '<span class="text-red-600">Error: ' + event.error + '</span>';
    }
    
    setTimeout(() => {
      statusSpan.innerHTML = '';
    }, 3000);
  };
  
  // Start recognition
  try {
    chatRecognition.start();
  } catch (error) {
    console.error('Failed to start recognition:', error);
    stopChatRecording();
  }
}

function stopChatRecording() {
  if (chatRecognition) {
    chatRecognition.stop();
    chatRecognition = null;
  }
  
  const voiceBtn = document.getElementById('chatVoiceBtn');
  const statusSpan = document.getElementById('chatTypingStatus');
  
  voiceBtn.classList.remove('recording');
  statusSpan.innerHTML = '';
  isChatRecording = false;
}
// Clear Chat History
function clearChatHistory() {
  // Confirm before clearing
  if (!confirm('Are you sure you want to clear all chat messages?\n\nà¤•à¥à¤¯à¤¾ à¤†à¤ª à¤¸à¤­à¥€ à¤šà¥ˆà¤Ÿ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤¸à¤¾à¤«à¤¼ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?')) {
    return;
  }
  
  const chatMessages = document.getElementById('chatMessages');
  
  // Clear all messages
  chatMessages.innerHTML = '';
  
  // Add welcome message back
  const welcomeDiv = document.createElement('div');
  welcomeDiv.className = 'flex gap-3 items-start';
  welcomeDiv.innerHTML = `
    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
      ğŸ•‰
    </div>
    <div class="bg-white rounded-2xl rounded-tl-none shadow-md p-4 max-w-[85%]">
      <p class="text-sm text-gray-800">
        ğŸ‘‹ Namaste! I'm <strong>Kurukshetra Mitra</strong>, your AI heritage guide.<br><br>
        Ask me anything about India's Kurukshetra - pilgrimage, temples, culture, history, services.
      </p>
      <p class="text-xs text-gray-400 mt-2">${getCurrentTime()}</p>
    </div>
  `;
  
chatMessages.appendChild(welcomeDiv);

// Add quick examples back
const examplesHTML = `
<div class="px-2">
  <p class="text-xs text-gray-500 mb-2 font-semibold">âœ¨ Try asking:</p>
  
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
    <button onclick="askQuickQuestion('Where is Jyotisar and how do I reach it?')" 
            class="text-left p-3 bg-white hover:bg-purple-50 border-2 border-purple-200 rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ“‹</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-purple-700">Where is Jyotisar and how do I reach it?</p>
          <p class="text-xs text-gray-500 mt-0.5">Location & directions</p>
        </div>
      </div>
    </button>
    
    <button onclick="askQuickQuestion('What is the significance of Brahma Sarovar?')" 
            class="text-left p-3 bg-white hover:bg-blue-50 border-2 border-blue-200 rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ”</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-blue-700">Significance of Brahma Sarovar?</p>
          <p class="text-xs text-gray-500 mt-0.5">Spiritual importance</p>
        </div>
      </div>
    </button>
    
    <button onclick="askQuickQuestion('Best hotels and accommodation in Kurukshetra?')" 
            class="text-left p-3 bg-white hover:bg-green-50 border-2 border-green-200 rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ’»</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-green-700">Best hotels in Kurukshetra?</p>
          <p class="text-xs text-gray-500 mt-0.5">Accommodation options</p>
        </div>
      </div>
    </button>
    
    <button onclick="askQuickQuestion('What are the main festivals celebrated here?')" 
            class="text-left p-2 md:p-3 bg-white hover:bg-orange-50 border-2 border-orange-200 rounded-lg md:rounded-xl transition group">
      <div class="flex items-start gap-2">
        <span class="text-lg">ğŸ•‰</span>
        <div class="flex-1">
          <p class="text-xs font-semibold text-gray-900 group-hover:text-orange-700">Festivals in Kurukshetra?</p>
          <p class="text-xs text-gray-500 mt-0.5">Cultural events</p>
        </div>
      </div>
    </button>
  </div>
</div>
`;

const examplesDiv = document.createElement('div');
examplesDiv.innerHTML = examplesHTML;
chatMessages.appendChild(examplesDiv.firstElementChild);

console.log('âœ… Chat history cleared');
}
// Quick Question Handler
function askQuickQuestion(question) {
  document.getElementById('chatInput').value = question;
  sendChatMessage();
}

// Smart auto-selection based on user type
// Smart auto-selection based on user type
function autoSelectTopicForUserType() {
  // Use the selectedUser variable instead of trying to read from DOM
  const userType = selectedUser || 'citizen';
  
  console.log('ğŸ¯ Auto-selecting topic for user type:', userType);
  
  // Define best default topic for each user type
  const defaultTopics = {
    'citizen': 'rights',        // Citizens want to know their rights
    'police': 'fir',            // Police deal with FIR procedures
    'student': 'trial',         // Students study trial processes
    'legal': 'bail'             // Lawyers frequently handle bail matters
  };
  
  // Get the appropriate topic for current user type
  const defaultTopic = defaultTopics[userType] || 'rights';
  
  console.log('ğŸ“Œ Selected default topic:', defaultTopic);
  
  // Select the topic after a brief delay
  setTimeout(() => {
    selectTopic(defaultTopic);
  }, 200);
}

// Make it globally accessible
window.autoSelectTopicForUserType = autoSelectTopicForUserType;  

// Sync language selectors
document.addEventListener('DOMContentLoaded', function() {
  const langCustom = document.getElementById('languageSelect');
  const langReady = document.getElementById('languageSelectReady');
  
  if (langCustom && langReady) {
    // When custom changes, update ready
    langCustom.addEventListener('change', function() {
      langReady.value = langCustom.value;
    });
    
    // When ready changes, update custom
    langReady.addEventListener('change', function() {
      langCustom.value = langReady.value;
    });
  }
});
</script>



</body>
</html>
